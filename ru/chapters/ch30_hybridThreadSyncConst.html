<!doctype html>
<html lang="ru-RU">
  <head>
    <meta charset="utf-8" />
    <meta name="viewport" content="width=device-width,initial-scale=1" />
    <meta name="generator" content="VuePress 2.0.0-rc.9" />
    <style>
      :root {
        --c-bg: #fff;
      }
      html.dark {
        --c-bg: #22272e;
      }
      html,
      body {
        background-color: var(--c-bg);
      }
    </style>
    <script>
      const userMode = localStorage.getItem('vuepress-color-scheme')
      const systemDarkMode =
        window.matchMedia &&
        window.matchMedia('(prefers-color-scheme: dark)').matches
      if (userMode === 'dark' || (userMode !== 'light' && systemDarkMode)) {
        document.documentElement.classList.toggle('dark', true)
      }
    </script>
    <link rel="icon" href="/assets/img/favicon.ico"><title>Гибридные конструкции синхронизации потоков | CLR via C#</title><meta name="description" content="CLR via C# Четвертое издание">
    <link rel="preload" href="/clr-via-csharp/assets/style-FaCSB-_p.css" as="style"><link rel="stylesheet" href="/clr-via-csharp/assets/style-FaCSB-_p.css">
    <link rel="modulepreload" href="/clr-via-csharp/assets/app-IxoMmWNN.js"><link rel="modulepreload" href="/clr-via-csharp/assets/ch30_hybridThreadSyncConst.html-D2MW45gx.js">
    <link rel="prefetch" href="/clr-via-csharp/assets/index.html-ZkH5qKEm.js" as="script"><link rel="prefetch" href="/clr-via-csharp/assets/index.html-BvaI8qfN.js" as="script"><link rel="prefetch" href="/clr-via-csharp/assets/Postscript.html-D-7172Jl.js" as="script"><link rel="prefetch" href="/clr-via-csharp/assets/ch01_TheCLRSExecutionMode.html-BLQSYEbL.js" as="script"><link rel="prefetch" href="/clr-via-csharp/assets/ch02_Building.html-Cmb5tXx5.js" as="script"><link rel="prefetch" href="/clr-via-csharp/assets/ch03_SharedAssemblies.html-C65m3L6w.js" as="script"><link rel="prefetch" href="/clr-via-csharp/assets/ch04_TypeFundamentals.html-MhrBc603.js" as="script"><link rel="prefetch" href="/clr-via-csharp/assets/ch05_PrimitiveRefValType.html-BExRN6IU.js" as="script"><link rel="prefetch" href="/clr-via-csharp/assets/ch06_TypeAndMemberBasics.html-Cwf82xZd.js" as="script"><link rel="prefetch" href="/clr-via-csharp/assets/ch07_ConstantsAndFields.html-U9jK40Ei.js" as="script"><link rel="prefetch" href="/clr-via-csharp/assets/ch08_Methods.html-CUDFuVYa.js" as="script"><link rel="prefetch" href="/clr-via-csharp/assets/ch09_Parameters.html-0oTJyJmn.js" as="script"><link rel="prefetch" href="/clr-via-csharp/assets/ch10_Properties.html-LLUaep7w.js" as="script"><link rel="prefetch" href="/clr-via-csharp/assets/ch11_Events.html-Bi9j89Ya.js" as="script"><link rel="prefetch" href="/clr-via-csharp/assets/ch12_Generics.html-Dbx7WK6o.js" as="script"><link rel="prefetch" href="/clr-via-csharp/assets/ch13_Interfaces.html-DsmoFQbF.js" as="script"><link rel="prefetch" href="/clr-via-csharp/assets/ch14_CharStringText.html-noMBAT3f.js" as="script"><link rel="prefetch" href="/clr-via-csharp/assets/ch15_EnumeratedTypes.html-MFb5H9zK.js" as="script"><link rel="prefetch" href="/clr-via-csharp/assets/ch16_Arrays.html-ZDLMr6H2.js" as="script"><link rel="prefetch" href="/clr-via-csharp/assets/ch17_Delegates.html-DYgFyOwD.js" as="script"><link rel="prefetch" href="/clr-via-csharp/assets/ch18_CustomAttributes.html-BtysPki2.js" as="script"><link rel="prefetch" href="/clr-via-csharp/assets/ch19_NullableValueTypes.html-CDUugoVg.js" as="script"><link rel="prefetch" href="/clr-via-csharp/assets/ch20_ExceptionsAndStateManae.html-BWeh_aT3.js" as="script"><link rel="prefetch" href="/clr-via-csharp/assets/ch21_ManagedHeapGarbage.html-CfeNN69i.js" as="script"><link rel="prefetch" href="/clr-via-csharp/assets/ch22_CLRHostingAndAppDomain.html-D16BElAb.js" as="script"><link rel="prefetch" href="/clr-via-csharp/assets/ch23_AssemblyLoaingReflection.html-DK1leolo.js" as="script"><link rel="prefetch" href="/clr-via-csharp/assets/ch24_RuntimeSerialization.html-CQ2ygEuE.js" as="script"><link rel="prefetch" href="/clr-via-csharp/assets/ch25_WinRTComponents.html-C3cvw10V.js" as="script"><link rel="prefetch" href="/clr-via-csharp/assets/ch26_ThreadBasics.html-CMPdATok.js" as="script"><link rel="prefetch" href="/clr-via-csharp/assets/ch27_ComputeBoundAsync.html-CTieDbCf.js" as="script"><link rel="prefetch" href="/clr-via-csharp/assets/ch28_IOBoundAsyncOperations.html-CJcp4OCy.js" as="script"><link rel="prefetch" href="/clr-via-csharp/assets/ch29_PrimitiveThreadSyncConstructs.html-CFsstSQQ.js" as="script"><link rel="prefetch" href="/clr-via-csharp/assets/ch30_hybridThreadSyncConst.html-beZI77Lv.js" as="script"><link rel="prefetch" href="/clr-via-csharp/assets/foreword.html-Bi67Yt5h.js" as="script"><link rel="prefetch" href="/clr-via-csharp/assets/introduction.html-dvExR8Gk.js" as="script"><link rel="prefetch" href="/clr-via-csharp/assets/index.html-GDcN_xMH.js" as="script"><link rel="prefetch" href="/clr-via-csharp/assets/ch01_TheCLRSExecutionMode.html-BwKxRLwh.js" as="script"><link rel="prefetch" href="/clr-via-csharp/assets/ch02_Building.html-BMQPeoI2.js" as="script"><link rel="prefetch" href="/clr-via-csharp/assets/ch03_SharedAssemblies.html-27zHcXlW.js" as="script"><link rel="prefetch" href="/clr-via-csharp/assets/ch04_TypeFundamentals.html-CVDf2x4Y.js" as="script"><link rel="prefetch" href="/clr-via-csharp/assets/ch05_PrimitiveRefValType.html-DkaxxntM.js" as="script"><link rel="prefetch" href="/clr-via-csharp/assets/ch06_TypeAndMemberBasics.html-BGwRCWdf.js" as="script"><link rel="prefetch" href="/clr-via-csharp/assets/ch07_ConstantsAndFields.html-D2jgyLeB.js" as="script"><link rel="prefetch" href="/clr-via-csharp/assets/ch08_Methods.html-CcZqtO9s.js" as="script"><link rel="prefetch" href="/clr-via-csharp/assets/ch09_Parameters.html-Cgf_mCwx.js" as="script"><link rel="prefetch" href="/clr-via-csharp/assets/ch10_Properties.html-CO8XAMmW.js" as="script"><link rel="prefetch" href="/clr-via-csharp/assets/ch11_Events.html-DZ5a5JQg.js" as="script"><link rel="prefetch" href="/clr-via-csharp/assets/ch12_Generics.html-D0mGmkov.js" as="script"><link rel="prefetch" href="/clr-via-csharp/assets/ch13_Interfaces.html-BGdd7LBY.js" as="script"><link rel="prefetch" href="/clr-via-csharp/assets/ch14_CharStringText.html-DExRFCv1.js" as="script"><link rel="prefetch" href="/clr-via-csharp/assets/ch15_EnumeratedTypes.html-BiTZ-5od.js" as="script"><link rel="prefetch" href="/clr-via-csharp/assets/ch16_Arrays.html-Dsjpqw47.js" as="script"><link rel="prefetch" href="/clr-via-csharp/assets/ch17_Delegates.html-DWEP33D9.js" as="script"><link rel="prefetch" href="/clr-via-csharp/assets/ch18_CustomAttributes.html-DtaR-VvP.js" as="script"><link rel="prefetch" href="/clr-via-csharp/assets/ch19_NullableValueTypes.html-CvrkASkk.js" as="script"><link rel="prefetch" href="/clr-via-csharp/assets/ch20_ExceptionsAndStateManae.html-BuN-nGuz.js" as="script"><link rel="prefetch" href="/clr-via-csharp/assets/ch21_ManagedHeapGarbage.html-f0AOnmUF.js" as="script"><link rel="prefetch" href="/clr-via-csharp/assets/ch22_CLRHostingAndAppDomain.html-C4pcwqj-.js" as="script"><link rel="prefetch" href="/clr-via-csharp/assets/ch23_AssemblyLoaingReflection.html-CHZCU__5.js" as="script"><link rel="prefetch" href="/clr-via-csharp/assets/ch24_RuntimeSerialization.html-emd0r8wc.js" as="script"><link rel="prefetch" href="/clr-via-csharp/assets/ch25_WinRTComponents.html-BmMk3Oqy.js" as="script"><link rel="prefetch" href="/clr-via-csharp/assets/ch26_ThreadBasics.html-DDuBq2h_.js" as="script"><link rel="prefetch" href="/clr-via-csharp/assets/ch27_ComputeBoundAsync.html-DXXfHTUn.js" as="script"><link rel="prefetch" href="/clr-via-csharp/assets/ch28_IOBoundAsyncOperations.html-CwFR1TuA.js" as="script"><link rel="prefetch" href="/clr-via-csharp/assets/ch29_PrimitiveThreadSyncConstructs.html-Bjaf8DNA.js" as="script"><link rel="prefetch" href="/clr-via-csharp/assets/Postscript.html-Bpkc--tR.js" as="script"><link rel="prefetch" href="/clr-via-csharp/assets/ch01_TheCLRSExecutionMode.html-BPnkWvJ8.js" as="script"><link rel="prefetch" href="/clr-via-csharp/assets/ch02_Building.html-q0yDwRpt.js" as="script"><link rel="prefetch" href="/clr-via-csharp/assets/ch03_SharedAssemblies.html-BjqQ7sdC.js" as="script"><link rel="prefetch" href="/clr-via-csharp/assets/ch04_TypeFundamentals.html-BIIy8leD.js" as="script"><link rel="prefetch" href="/clr-via-csharp/assets/ch05_PrimitiveRefValType.html-BOo-9fso.js" as="script"><link rel="prefetch" href="/clr-via-csharp/assets/ch06_TypeAndMemberBasics.html-DzDrvZ87.js" as="script"><link rel="prefetch" href="/clr-via-csharp/assets/ch07_ConstantsAndFields.html-CASmG777.js" as="script"><link rel="prefetch" href="/clr-via-csharp/assets/ch08_Methods.html-CEM163Qb.js" as="script"><link rel="prefetch" href="/clr-via-csharp/assets/ch09_Parameters.html-BkR6SOXn.js" as="script"><link rel="prefetch" href="/clr-via-csharp/assets/ch10_Properties.html-sfPfXudR.js" as="script"><link rel="prefetch" href="/clr-via-csharp/assets/ch11_Events.html-LJfkVvEp.js" as="script"><link rel="prefetch" href="/clr-via-csharp/assets/ch12_Generics.html-CSXiWNpq.js" as="script"><link rel="prefetch" href="/clr-via-csharp/assets/ch13_Interfaces.html-CBasocgy.js" as="script"><link rel="prefetch" href="/clr-via-csharp/assets/ch14_CharStringText.html-o4yS52Dy.js" as="script"><link rel="prefetch" href="/clr-via-csharp/assets/ch15_EnumeratedTypes.html-BZtqvWYE.js" as="script"><link rel="prefetch" href="/clr-via-csharp/assets/ch16_Arrays.html-CGp-_Jrw.js" as="script"><link rel="prefetch" href="/clr-via-csharp/assets/ch17_Delegates.html-tcKP_pXy.js" as="script"><link rel="prefetch" href="/clr-via-csharp/assets/ch18_CustomAttributes.html-B6RvN9hy.js" as="script"><link rel="prefetch" href="/clr-via-csharp/assets/ch19_NullableValueTypes.html-BkMiV6yx.js" as="script"><link rel="prefetch" href="/clr-via-csharp/assets/ch20_ExceptionsAndStateManae.html-BsTwrSmr.js" as="script"><link rel="prefetch" href="/clr-via-csharp/assets/ch21_ManagedHeapGarbage.html-BDn6rSrD.js" as="script"><link rel="prefetch" href="/clr-via-csharp/assets/ch22_CLRHostingAndAppDomain.html-Bi_35IQj.js" as="script"><link rel="prefetch" href="/clr-via-csharp/assets/ch23_AssemblyLoaingReflection.html-stJPEo8t.js" as="script"><link rel="prefetch" href="/clr-via-csharp/assets/ch24_RuntimeSerialization.html-BexV0ImS.js" as="script"><link rel="prefetch" href="/clr-via-csharp/assets/ch25_WinRTComponents.html-Cw_fsfmx.js" as="script"><link rel="prefetch" href="/clr-via-csharp/assets/ch26_ThreadBasics.html-QnhhtSZl.js" as="script"><link rel="prefetch" href="/clr-via-csharp/assets/ch27_ComputeBoundAsync.html-DNJcQUkI.js" as="script"><link rel="prefetch" href="/clr-via-csharp/assets/ch28_IOBoundAsyncOperations.html-BAwtWkjU.js" as="script"><link rel="prefetch" href="/clr-via-csharp/assets/ch29_PrimitiveThreadSyncConstructs.html-5-bQNQmT.js" as="script"><link rel="prefetch" href="/clr-via-csharp/assets/ch30_hybridThreadSyncConst.html-DKmbpj4c.js" as="script"><link rel="prefetch" href="/clr-via-csharp/assets/foreword.html-GASyXvmd.js" as="script"><link rel="prefetch" href="/clr-via-csharp/assets/introduction.html-D6bO62ut.js" as="script"><link rel="prefetch" href="/clr-via-csharp/assets/404.html-5gOqppNC.js" as="script">
  </head>
  <body>
    <div id="app"><!--[--><div class="theme-container"><!--[--><header class="navbar"><div class="toggle-sidebar-button" title="toggle sidebar" aria-expanded="false" role="button" tabindex="0"><div class="icon" aria-hidden="true"><span></span><span></span><span></span></div></div><span><a class="route-link" href="/clr-via-csharp/ru/"><img class="logo" src="/clr-via-csharp/assets/images/cover.jpg" alt="CLR via C#"><span class="site-name can-hide" aria-hidden="true">CLR via C#</span></a></span><div class="navbar-items-wrapper" style=""><!--[--><!--]--><nav class="navbar-items can-hide" aria-label="site navigation"><!--[--><div class="navbar-item"><div class="navbar-dropdown-wrapper"><button class="navbar-dropdown-title" type="button" aria-label="Select language"><span class="title">Выберите язык</span><span class="arrow down"></span></button><button class="navbar-dropdown-title-mobile" type="button" aria-label="Select language"><span class="title">Выберите язык</span><span class="right arrow"></span></button><ul style="display:none;" class="navbar-dropdown"><!--[--><li class="navbar-dropdown-item"><a class="route-link" href="/clr-via-csharp/chapters/ch30_hybridThreadSyncConst.html" aria-label="简体中文"><!--[--><!--[--><!--]--> 简体中文 <!--[--><!--]--><!--]--></a></li><li class="navbar-dropdown-item"><a class="route-link route-link-active" href="/clr-via-csharp/" aria-label="Русский"><!--[--><!--[--><!--]--> Русский <!--[--><!--]--><!--]--></a></li><!--]--></ul></div></div><div class="navbar-item"><a class="external-link" href="https://github.com/arytry/clr-via-csharp" rel="noopener noreferrer" target="_blank" aria-label="GitHub"><!--[--><!--[--><!--]--> GitHub <span><svg class="external-link-icon" xmlns="http://www.w3.org/2000/svg" aria-hidden="true" focusable="false" x="0px" y="0px" viewBox="0 0 100 100" width="15" height="15"><path fill="currentColor" d="M18.8,85.1h56l0,0c2.2,0,4-1.8,4-4v-32h-8v28h-48v-48h28v-8h-32l0,0c-2.2,0-4,1.8-4,4v56C14.8,83.3,16.6,85.1,18.8,85.1z"></path><polygon fill="currentColor" points="45.7,48.7 51.3,54.3 77.2,28.5 77.2,37.2 85.2,37.2 85.2,14.9 62.8,14.9 62.8,22.9 71.5,22.9"></polygon></svg><span class="external-link-icon-sr-only">open in new window</span></span><!--[--><!--]--><!--]--></a></div><!--]--></nav><!--[--><!--]--><button class="toggle-color-mode-button" title="toggle color mode"><svg style="" class="icon" focusable="false" viewBox="0 0 32 32"><path d="M16 12.005a4 4 0 1 1-4 4a4.005 4.005 0 0 1 4-4m0-2a6 6 0 1 0 6 6a6 6 0 0 0-6-6z" fill="currentColor"></path><path d="M5.394 6.813l1.414-1.415l3.506 3.506L8.9 10.318z" fill="currentColor"></path><path d="M2 15.005h5v2H2z" fill="currentColor"></path><path d="M5.394 25.197L8.9 21.691l1.414 1.415l-3.506 3.505z" fill="currentColor"></path><path d="M15 25.005h2v5h-2z" fill="currentColor"></path><path d="M21.687 23.106l1.414-1.415l3.506 3.506l-1.414 1.414z" fill="currentColor"></path><path d="M25 15.005h5v2h-5z" fill="currentColor"></path><path d="M21.687 8.904l3.506-3.506l1.414 1.415l-3.506 3.505z" fill="currentColor"></path><path d="M15 2.005h2v5h-2z" fill="currentColor"></path></svg><svg style="display:none;" class="icon" focusable="false" viewBox="0 0 32 32"><path d="M13.502 5.414a15.075 15.075 0 0 0 11.594 18.194a11.113 11.113 0 0 1-7.975 3.39c-.138 0-.278.005-.418 0a11.094 11.094 0 0 1-3.2-21.584M14.98 3a1.002 1.002 0 0 0-.175.016a13.096 13.096 0 0 0 1.825 25.981c.164.006.328 0 .49 0a13.072 13.072 0 0 0 10.703-5.555a1.01 1.01 0 0 0-.783-1.565A13.08 13.08 0 0 1 15.89 4.38A1.015 1.015 0 0 0 14.98 3z" fill="currentColor"></path></svg></button><!----></div></header><!--]--><div class="sidebar-mask"></div><!--[--><aside class="sidebar"><nav class="navbar-items" aria-label="site navigation"><!--[--><div class="navbar-item"><div class="navbar-dropdown-wrapper"><button class="navbar-dropdown-title" type="button" aria-label="Select language"><span class="title">Выберите язык</span><span class="arrow down"></span></button><button class="navbar-dropdown-title-mobile" type="button" aria-label="Select language"><span class="title">Выберите язык</span><span class="right arrow"></span></button><ul style="display:none;" class="navbar-dropdown"><!--[--><li class="navbar-dropdown-item"><a class="route-link" href="/clr-via-csharp/chapters/ch30_hybridThreadSyncConst.html" aria-label="简体中文"><!--[--><!--[--><!--]--> 简体中文 <!--[--><!--]--><!--]--></a></li><li class="navbar-dropdown-item"><a class="route-link route-link-active" href="/clr-via-csharp/" aria-label="Русский"><!--[--><!--[--><!--]--> Русский <!--[--><!--]--><!--]--></a></li><!--]--></ul></div></div><div class="navbar-item"><a class="external-link" href="https://github.com/arytry/clr-via-csharp" rel="noopener noreferrer" target="_blank" aria-label="GitHub"><!--[--><!--[--><!--]--> GitHub <span><svg class="external-link-icon" xmlns="http://www.w3.org/2000/svg" aria-hidden="true" focusable="false" x="0px" y="0px" viewBox="0 0 100 100" width="15" height="15"><path fill="currentColor" d="M18.8,85.1h56l0,0c2.2,0,4-1.8,4-4v-32h-8v28h-48v-48h28v-8h-32l0,0c-2.2,0-4,1.8-4,4v56C14.8,83.3,16.6,85.1,18.8,85.1z"></path><polygon fill="currentColor" points="45.7,48.7 51.3,54.3 77.2,28.5 77.2,37.2 85.2,37.2 85.2,14.9 62.8,14.9 62.8,22.9 71.5,22.9"></polygon></svg><span class="external-link-icon-sr-only">open in new window</span></span><!--[--><!--]--><!--]--></a></div><!--]--></nav><!--[--><!--]--><ul class="sidebar-items"><!--[--><li><a class="route-link sidebar-item sidebar-heading" href="/clr-via-csharp/ru/chapters/ch01_TheCLRSExecutionMode.html" aria-label="Модель выполнения кода в среде CLR"><!--[--><!--[--><!--]--> Модель выполнения кода в среде CLR <!--[--><!--]--><!--]--></a><!----></li><li><a class="route-link sidebar-item sidebar-heading" href="/clr-via-csharp/ru/chapters/ch02_Building.html" aria-label="Компоновка, упаковка, развёртывание и администрирование приложений и типов"><!--[--><!--[--><!--]--> Компоновка, упаковка, развёртывание и администрирование приложений и типов <!--[--><!--]--><!--]--></a><!----></li><li><a class="route-link sidebar-item sidebar-heading" href="/clr-via-csharp/ru/chapters/ch03_SharedAssemblies.html" aria-label="Совместно используемые сборки и сборки со строгим именем"><!--[--><!--[--><!--]--> Совместно используемые сборки и сборки со строгим именем <!--[--><!--]--><!--]--></a><!----></li><li><a class="route-link sidebar-item sidebar-heading" href="/clr-via-csharp/ru/chapters/ch04_TypeFundamentals.html" aria-label="Основы типов"><!--[--><!--[--><!--]--> Основы типов <!--[--><!--]--><!--]--></a><!----></li><li><a class="route-link sidebar-item sidebar-heading" href="/clr-via-csharp/ru/chapters/ch05_PrimitiveRefValType.html" aria-label="Примитивные, ссылочные и значимые типы"><!--[--><!--[--><!--]--> Примитивные, ссылочные и значимые типы <!--[--><!--]--><!--]--></a><!----></li><li><a class="route-link sidebar-item sidebar-heading" href="/clr-via-csharp/ru/chapters/ch06_TypeAndMemberBasics.html" aria-label="Основные сведения о членах и типах"><!--[--><!--[--><!--]--> Основные сведения о членах и типах <!--[--><!--]--><!--]--></a><!----></li><li><a class="route-link sidebar-item sidebar-heading" href="/clr-via-csharp/ru/chapters/ch07_ConstantsAndFields.html" aria-label="Константы и поля"><!--[--><!--[--><!--]--> Константы и поля <!--[--><!--]--><!--]--></a><!----></li><li><a class="route-link sidebar-item sidebar-heading" href="/clr-via-csharp/ru/chapters/ch08_Methods.html" aria-label="Методы"><!--[--><!--[--><!--]--> Методы <!--[--><!--]--><!--]--></a><!----></li><li><a class="route-link sidebar-item sidebar-heading" href="/clr-via-csharp/ru/chapters/ch09_Parameters.html" aria-label="Параметры"><!--[--><!--[--><!--]--> Параметры <!--[--><!--]--><!--]--></a><!----></li><li><a class="route-link sidebar-item sidebar-heading" href="/clr-via-csharp/ru/chapters/ch10_Properties.html" aria-label="Свойства"><!--[--><!--[--><!--]--> Свойства <!--[--><!--]--><!--]--></a><!----></li><li><a class="route-link sidebar-item sidebar-heading" href="/clr-via-csharp/ru/chapters/ch11_Events.html" aria-label="События"><!--[--><!--[--><!--]--> События <!--[--><!--]--><!--]--></a><!----></li><li><a class="route-link sidebar-item sidebar-heading" href="/clr-via-csharp/ru/chapters/ch12_Generics.html" aria-label="Обобщения"><!--[--><!--[--><!--]--> Обобщения <!--[--><!--]--><!--]--></a><!----></li><li><a class="route-link sidebar-item sidebar-heading" href="/clr-via-csharp/ru/chapters/ch13_Interfaces.html" aria-label="Интерфейсы"><!--[--><!--[--><!--]--> Интерфейсы <!--[--><!--]--><!--]--></a><!----></li><li><a class="route-link sidebar-item sidebar-heading" href="/clr-via-csharp/ru/chapters/ch14_CharStringText.html" aria-label="Символы, строки и обработка текста"><!--[--><!--[--><!--]--> Символы, строки и обработка текста <!--[--><!--]--><!--]--></a><!----></li><li><a class="route-link sidebar-item sidebar-heading" href="/clr-via-csharp/ru/chapters/ch15_EnumeratedTypes.html" aria-label="Перечислимые типы и битовые флаги"><!--[--><!--[--><!--]--> Перечислимые типы и битовые флаги <!--[--><!--]--><!--]--></a><!----></li><li><a class="route-link sidebar-item sidebar-heading" href="/clr-via-csharp/ru/chapters/ch16_Arrays.html" aria-label="Массивы"><!--[--><!--[--><!--]--> Массивы <!--[--><!--]--><!--]--></a><!----></li><li><a class="route-link sidebar-item sidebar-heading" href="/clr-via-csharp/ru/chapters/ch17_Delegates.html" aria-label="Делегаты"><!--[--><!--[--><!--]--> Делегаты <!--[--><!--]--><!--]--></a><!----></li><li><a class="route-link sidebar-item sidebar-heading" href="/clr-via-csharp/ru/chapters/ch18_CustomAttributes.html" aria-label="Настраиваемые атрибуты"><!--[--><!--[--><!--]--> Настраиваемые атрибуты <!--[--><!--]--><!--]--></a><!----></li><li><a class="route-link sidebar-item sidebar-heading" href="/clr-via-csharp/ru/chapters/ch19_NullableValueTypes.html" aria-label="Null-совместимые значимые типы"><!--[--><!--[--><!--]--> Null-совместимые значимые типы <!--[--><!--]--><!--]--></a><!----></li><li><a class="route-link sidebar-item sidebar-heading" href="/clr-via-csharp/ru/chapters/ch20_ExceptionsAndStateManae.html" aria-label="Исключения и управление состоянием"><!--[--><!--[--><!--]--> Исключения и управление состоянием <!--[--><!--]--><!--]--></a><!----></li><li><a class="route-link sidebar-item sidebar-heading" href="/clr-via-csharp/ru/chapters/ch21_ManagedHeapGarbage.html" aria-label="Автоматическое управление памятью (сборка мусора)"><!--[--><!--[--><!--]--> Автоматическое управление памятью (сборка мусора) <!--[--><!--]--><!--]--></a><!----></li><li><a class="route-link sidebar-item sidebar-heading" href="/clr-via-csharp/ru/chapters/ch22_CLRHostingAndAppDomain.html" aria-label="Хостинг CLR и домены приложений"><!--[--><!--[--><!--]--> Хостинг CLR и домены приложений <!--[--><!--]--><!--]--></a><!----></li><li><a class="route-link sidebar-item sidebar-heading" href="/clr-via-csharp/ru/chapters/ch23_AssemblyLoaingReflection.html" aria-label="Загрузка сборок и отражение"><!--[--><!--[--><!--]--> Загрузка сборок и отражение <!--[--><!--]--><!--]--></a><!----></li><li><a class="route-link sidebar-item sidebar-heading" href="/clr-via-csharp/ru/chapters/ch24_RuntimeSerialization.html" aria-label="Сериализация"><!--[--><!--[--><!--]--> Сериализация <!--[--><!--]--><!--]--></a><!----></li><li><a class="route-link sidebar-item sidebar-heading" href="/clr-via-csharp/ru/chapters/ch25_WinRTComponents.html" aria-label="Взаимодействие с компонентами WinRT"><!--[--><!--[--><!--]--> Взаимодействие с компонентами WinRT <!--[--><!--]--><!--]--></a><!----></li><li><a class="route-link sidebar-item sidebar-heading" href="/clr-via-csharp/ru/chapters/ch26_ThreadBasics.html" aria-label="Потоки исполнения"><!--[--><!--[--><!--]--> Потоки исполнения <!--[--><!--]--><!--]--></a><!----></li><li><a class="route-link sidebar-item sidebar-heading" href="/clr-via-csharp/ru/chapters/ch27_ComputeBoundAsync.html" aria-label="Асинхронные вычислительные операции"><!--[--><!--[--><!--]--> Асинхронные вычислительные операции <!--[--><!--]--><!--]--></a><!----></li><li><a class="route-link sidebar-item sidebar-heading" href="/clr-via-csharp/ru/chapters/ch28_IOBoundAsyncOperations.html" aria-label="Асинхронные операции ввода-вывода"><!--[--><!--[--><!--]--> Асинхронные операции ввода-вывода <!--[--><!--]--><!--]--></a><!----></li><li><a class="route-link sidebar-item sidebar-heading" href="/clr-via-csharp/ru/chapters/ch29_PrimitiveThreadSyncConstructs.html" aria-label="Примитивные конструкции синхронизации потоков"><!--[--><!--[--><!--]--> Примитивные конструкции синхронизации потоков <!--[--><!--]--><!--]--></a><!----></li><li><a class="route-link route-link-active sidebar-item sidebar-heading active" href="/clr-via-csharp/ru/chapters/ch30_hybridThreadSyncConst.html" aria-label="Гибридные конструкции синхронизации потоков"><!--[--><!--[--><!--]--> Гибридные конструкции синхронизации потоков <!--[--><!--]--><!--]--></a><ul style="" class="sidebar-item-children"><!--[--><li><a class="route-link sidebar-item" href="#простая-гибридная-блокировка" aria-label="Простая гибридная блокировка"><!--[--><!--[--><!--]--> Простая гибридная блокировка <!--[--><!--]--><!--]--></a><!----></li><li><a class="route-link sidebar-item" href="#зацикливание-владение-потоком-и-рекурсия" aria-label="Зацикливание, владение потоком и рекурсия"><!--[--><!--[--><!--]--> Зацикливание, владение потоком и рекурсия <!--[--><!--]--><!--]--></a><!----></li><li><a class="route-link sidebar-item" href="#гибридные-конструкции-в-fcl" aria-label="Гибридные конструкции в FCL"><!--[--><!--[--><!--]--> Гибридные конструкции в FCL <!--[--><!--]--><!--]--></a><ul style="" class="sidebar-item-children"><!--[--><li><a class="route-link sidebar-item" href="#классы-manualreseteventslim-и-semaphoreslim" aria-label="Классы ManualResetEventSlim и SemaphoreSlim"><!--[--><!--[--><!--]--> Классы ManualResetEventSlim и SemaphoreSlim <!--[--><!--]--><!--]--></a><!----></li><li><a class="route-link sidebar-item" href="#класс-monitor-и-блоки-синхронизации" aria-label="Класс Monitor и блоки синхронизации"><!--[--><!--[--><!--]--> Класс Monitor и блоки синхронизации <!--[--><!--]--><!--]--></a><!----></li><li><a class="route-link sidebar-item" href="#класс-readerwriterlockslim" aria-label="Класс ReaderWriterLockSlim"><!--[--><!--[--><!--]--> Класс ReaderWriterLockSlim <!--[--><!--]--><!--]--></a><!----></li><li><a class="route-link sidebar-item" href="#класс-onemanylock" aria-label="Класс OneManyLock"><!--[--><!--[--><!--]--> Класс OneManyLock <!--[--><!--]--><!--]--></a><!----></li><li><a class="route-link sidebar-item" href="#класс-countdownevent" aria-label="Класс CountdownEvent"><!--[--><!--[--><!--]--> Класс CountdownEvent <!--[--><!--]--><!--]--></a><!----></li><li><a class="route-link sidebar-item" href="#класс-barrier" aria-label="Класс Barrier"><!--[--><!--[--><!--]--> Класс Barrier <!--[--><!--]--><!--]--></a><!----></li><li><a class="route-link sidebar-item" href="#выводы-по-гибридным-конструкциям" aria-label="Выводы по гибридным конструкциям"><!--[--><!--[--><!--]--> Выводы по гибридным конструкциям <!--[--><!--]--><!--]--></a><!----></li><!--]--></ul></li><li><a class="route-link sidebar-item" href="#блокировка-с-двоинои-проверкои" aria-label="Блокировка с двойной проверкой"><!--[--><!--[--><!--]--> Блокировка с двойной проверкой <!--[--><!--]--><!--]--></a><!----></li><li><a class="route-link sidebar-item" href="#паттерн-условнои-переменнои" aria-label="Паттерн условной переменной"><!--[--><!--[--><!--]--> Паттерн условной переменной <!--[--><!--]--><!--]--></a><!----></li><li><a class="route-link sidebar-item" href="#асинхронная-синхронизация" aria-label="Асинхронная синхронизация"><!--[--><!--[--><!--]--> Асинхронная синхронизация <!--[--><!--]--><!--]--></a><!----></li><li><a class="route-link sidebar-item" href="#классы-коллекции-для-параллельного-доступа" aria-label="Классы коллекций для параллельного доступа"><!--[--><!--[--><!--]--> Классы коллекций для параллельного доступа <!--[--><!--]--><!--]--></a><!----></li><!--]--></ul></li><!--]--></ul><!--[--><!--]--></aside><!--]--><!--[--><main class="page"><!--[--><!--]--><div class="theme-default-content"><!--[--><!--]--><div><h1 id="гибридные-конструкции-синхронизации-потоков" tabindex="-1"><a class="header-anchor" href="#гибридные-конструкции-синхронизации-потоков"><span>Гибридные конструкции синхронизации потоков</span></a></h1><p>При отсутствии конкуренции потоков гибридные конструкции дают даже большую производительность, чем простейшие конструкции пользовательского режима.</p><h2 id="простая-гибридная-блокировка" tabindex="-1"><a class="header-anchor" href="#простая-гибридная-блокировка"><span>Простая гибридная блокировка</span></a></h2><p>В книге приводится пример простой гибридной блокировки на основе Interlocked-конструкции и AutoResetEvent.</p><h2 id="зацикливание-владение-потоком-и-рекурсия" tabindex="-1"><a class="header-anchor" href="#зацикливание-владение-потоком-и-рекурсия"><span>Зацикливание, владение потоком и рекурсия</span></a></h2><p>Так как переходы в ядро сильно снижают производительность, а потоки остаются запертыми короткое время, общую производительность можно повысить, заставив поток перед переходом в режим ядра на некоторое время зациклиться в пользовательском режиме. Если в это время блокирование, которого ждёт поток, станет возможным, переход в режим ядра не понадобится.</p><p>Некоторые варианты блокирования налагают ограничение, при котором получить право на блокировку может только поток, снимающий блокировку. В книге приводится пример гибридного блокирования, предполагающее одновременно зацикливание, владение потоком и рекурсию.</p><h2 id="гибридные-конструкции-в-fcl" tabindex="-1"><a class="header-anchor" href="#гибридные-конструкции-в-fcl"><span>Гибридные конструкции в FCL</span></a></h2><p>В FCL существует множество гибридных конструкций, которые призваны удержать потоки в пользовательском режиме, что повышает производительность.</p><h3 id="классы-manualreseteventslim-и-semaphoreslim" tabindex="-1"><a class="header-anchor" href="#классы-manualreseteventslim-и-semaphoreslim"><span>Классы ManualResetEventSlim и SemaphoreSlim</span></a></h3><p>Классы ManualResetEventSlim и SemaphoreSlim функционируют точно так же, как их аналоги режима ядра, отличаясь только зацикливанием в пользовательском режиме. Они не создают конструкций режима ядра до возникновения конкуренции.</p><h3 id="класс-monitor-и-блоки-синхронизации" tabindex="-1"><a class="header-anchor" href="#класс-monitor-и-блоки-синхронизации"><span>Класс Monitor и блоки синхронизации</span></a></h3><p>Самой популярной гибридной конструкцией является класс <code>Monitor</code>, обеспечивающий взаимоисключающее блокирование, владение потоком и рекурсией. Данная конструкция используется чаще других, так как является одной из самых старых. Для её поддержки в C# даже есть специальное ключевое слово, с ней по умолчанию умеет работать JIT-компилятор, а CLR пользуется ей от имени приложения. Однако работать с ней не просто, а получить некорректный код очень легко.</p><p>С каждым объектом в куче связан <em>блок синхронизации</em> (sync block). Этот блок содержит поля для объекта ядра, идентификатора потока-владельца, счётчика рекурсии и счётчика ожидающих потоков. Класс монитор является статическим и его методы принимают ссылки на любой объект из кучи. Управление полями эти методы осуществляют в блоке синхронизации заданного объекта.</p><p>Привязка блока синхронизации к каждому объекту в куче является очень расточительной, так как большинство объектов никогда не пользуются этим блоком. Для снижения потребления памяти, разработчики CLR применении более эффективный вариант реализации. Во время инициализации CLR выделяется массив блоков синхронизации. При создании объекта в куче инициализируется <em>индекс блока синхронизации</em> (sync block index), то есть индекс в массиве блоков синхронизации.</p><p>В момент конструирования объекта этому индексу присваивается -1. Затем при вызове метода <code>Monitor.Enter()</code> CLR обнаруживает свободный блок синхронизации и присваивает ссылку на него объекту. Метод <code>Exit()</code> проверяет наличие потоков, ожидающих блока синхронизации. Если таких потоков не обнаруживается, метод возвращает индексу значение -1, освобождая блоки синхронизации. Массив блоков синхронизации может быть увеличен, если в какой-то момент их станет недостаточно.</p><p><img src="https://github.com/kuzmin-nikita/CLR-via-CSharp/assets/80389873/1a842cc9-c4c0-45cb-b464-0001cb3a845b" alt="image"></p><p>В книге приводится пример корректного использования <code>Monitor</code>.</p><p>Так как разработчики привыкли устанавливать и снимать блокировку в одном и том же методе, в C# появился упрощённый синтаксис для этого:</p><div class="language-csharp line-numbers-mode" data-ext="cs" data-title="cs"><pre class="language-csharp"><code><span class="token keyword">private</span> <span class="token return-type class-name"><span class="token keyword">void</span></span> <span class="token function">SomeMethod</span><span class="token punctuation">(</span><span class="token punctuation">)</span>
<span class="token punctuation">{</span>
  <span class="token keyword">lock</span> <span class="token punctuation">(</span><span class="token keyword">this</span><span class="token punctuation">)</span>
  <span class="token punctuation">{</span>
    <span class="token comment">// Этот код имеет эксклюзивный доступ к данным...</span>
  <span class="token punctuation">}</span>
<span class="token punctuation">}</span>
</code></pre><div class="line-numbers" aria-hidden="true"><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div></div></div><p>Что эквивалентно:</p><div class="language-csharp line-numbers-mode" data-ext="cs" data-title="cs"><pre class="language-csharp"><code><span class="token keyword">private</span> <span class="token return-type class-name"><span class="token keyword">void</span></span> <span class="token function">SomeMethod</span><span class="token punctuation">(</span><span class="token punctuation">)</span>
<span class="token punctuation">{</span>
  <span class="token class-name">Boolean</span> lockTaken <span class="token operator">=</span> <span class="token boolean">false</span><span class="token punctuation">;</span>

  <span class="token keyword">try</span>
  <span class="token punctuation">{</span>
    <span class="token comment">// Исключение (например, ThreadAbortException) может здесь появиться</span>
    Monitor<span class="token punctuation">.</span><span class="token function">Enter</span><span class="token punctuation">(</span><span class="token keyword">this</span><span class="token punctuation">,</span> <span class="token keyword">ref</span> lockTaken<span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token comment">// Этот код имеет монопольный доступ к данным...</span>
  <span class="token punctuation">}</span>
  <span class="token keyword">finally</span>
  <span class="token punctuation">{</span>
    <span class="token keyword">if</span> <span class="token punctuation">(</span>lockTaken<span class="token punctuation">)</span>
      Monitor<span class="token punctuation">.</span><span class="token function">Exit</span><span class="token punctuation">(</span><span class="token keyword">this</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
  <span class="token punctuation">}</span>
<span class="token punctuation">}</span>
</code></pre><div class="line-numbers" aria-hidden="true"><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div></div></div><p>Это приводит к тому, что снятая в блоке <code>finally</code> блокировка (в ситуации, когда в блоке <code>try</code> повреждаются данные), позволит работать с повреждёнными данными другому потоку.</p><h3 id="класс-readerwriterlockslim" tabindex="-1"><a class="header-anchor" href="#класс-readerwriterlockslim"><span>Класс ReaderWriterLockSlim</span></a></h3><p>Если данные, которые читаются потоками, защищены взаимоисключающей блокировкой, то при попытке одновременного доступа нескольких потоков работу продолжит только один, а остальные блокируются, что ухудшает масштабируемость и снижает производительность. Хотя в случае одновременного чтение необходимости в блокировке нет, а вот при попытке записи требуется монопольный доступ. Конструкция <a href="https://learn.microsoft.com/en-us/dotnet/api/system.threading.readerwriterlockslim?view=net-8.0" target="_blank" rel="noopener noreferrer"><code>ReaderWriteLockSlim</code><span><svg class="external-link-icon" xmlns="http://www.w3.org/2000/svg" aria-hidden="true" focusable="false" x="0px" y="0px" viewBox="0 0 100 100" width="15" height="15"><path fill="currentColor" d="M18.8,85.1h56l0,0c2.2,0,4-1.8,4-4v-32h-8v28h-48v-48h28v-8h-32l0,0c-2.2,0-4,1.8-4,4v56C14.8,83.3,16.6,85.1,18.8,85.1z"></path><polygon fill="currentColor" points="45.7,48.7 51.3,54.3 77.2,28.5 77.2,37.2 85.2,37.2 85.2,14.9 62.8,14.9 62.8,22.9 71.5,22.9"></polygon></svg><span class="external-link-icon-sr-only">open in new window</span></span></a> призвана решить проблему, управляя потоками следующим образом:</p><ul><li>Если один поток осуществляет запись, все остальные потоки блокируются.</li><li>Если один поток читает, все остальные потоки продолжают работать; блокируются только те, которые ждут доступа на запись.</li><li>После завершения работы записывающего потока разблокируется либо один поток на запись, либо все читающий поток. При отсутствии заблокированных потоков блокировку получит следующий поток, которому это потребуется.</li><li>После завершения всех читающих потоков, разблокируется записывающий поток. При отсутствии заблокированных потоков блокировку получит следующий поток, которому это потребуется.</li></ul><h3 id="класс-onemanylock" tabindex="-1"><a class="header-anchor" href="#класс-onemanylock"><span>Класс OneManyLock</span></a></h3><p>Рихтер создал собственную конструкцию, которая работает быстрее, чем <code>ReaderWriteLockSlim</code>. Эта конструкция называется <code>OneManyLock</code>, так как она предоставляет доступ либо одному пишущему, либо многим читающим потокам. Подробнее в книге.</p><h3 id="класс-countdownevent" tabindex="-1"><a class="header-anchor" href="#класс-countdownevent"><span>Класс CountdownEvent</span></a></h3><p><a href="https://learn.microsoft.com/en-us/dotnet/api/system.threading.countdownevent?view=net-8.0" target="_blank" rel="noopener noreferrer"><code>System.Threading.CountdownEvent</code><span><svg class="external-link-icon" xmlns="http://www.w3.org/2000/svg" aria-hidden="true" focusable="false" x="0px" y="0px" viewBox="0 0 100 100" width="15" height="15"><path fill="currentColor" d="M18.8,85.1h56l0,0c2.2,0,4-1.8,4-4v-32h-8v28h-48v-48h28v-8h-32l0,0c-2.2,0-4,1.8-4,4v56C14.8,83.3,16.6,85.1,18.8,85.1z"></path><polygon fill="currentColor" points="45.7,48.7 51.3,54.3 77.2,28.5 77.2,37.2 85.2,37.2 85.2,14.9 62.8,14.9 62.8,22.9 71.5,22.9"></polygon></svg><span class="external-link-icon-sr-only">open in new window</span></span></a> построен на основе <code>ManualResetEventSlim</code> и блокирует поток до достижения внутренним счётчиком 0. Поведение этой конструкции диаметрально противоположно семафору.</p><h3 id="класс-barrier" tabindex="-1"><a class="header-anchor" href="#класс-barrier"><span>Класс Barrier</span></a></h3><p><a href="https://learn.microsoft.com/en-us/dotnet/api/system.threading.barrier?view=net-8.0" target="_blank" rel="noopener noreferrer"><code>System.Threading.Barrier</code><span><svg class="external-link-icon" xmlns="http://www.w3.org/2000/svg" aria-hidden="true" focusable="false" x="0px" y="0px" viewBox="0 0 100 100" width="15" height="15"><path fill="currentColor" d="M18.8,85.1h56l0,0c2.2,0,4-1.8,4-4v-32h-8v28h-48v-48h28v-8h-32l0,0c-2.2,0-4,1.8-4,4v56C14.8,83.3,16.6,85.1,18.8,85.1z"></path><polygon fill="currentColor" points="45.7,48.7 51.3,54.3 77.2,28.5 77.2,37.2 85.2,37.2 85.2,14.9 62.8,14.9 62.8,22.9 71.5,22.9"></polygon></svg><span class="external-link-icon-sr-only">open in new window</span></span></a> была создана для решения крайне редко возникающей проблемы, так что ею вряд ли придётся пользоваться. Она управляет группами параллельно выполняющихся потоков, обеспечивая одновременное прохождение ими всех фаз алгоритма.</p><h3 id="выводы-по-гибридным-конструкциям" tabindex="-1"><a class="header-anchor" href="#выводы-по-гибридным-конструкциям"><span>Выводы по гибридным конструкциям</span></a></h3><p>Стоит по возможности избегать кода, блокирующего потоки. При асинхронных вычислениях или операциях ввода-вывода стоит передавать данные от одного потока другому так, чтобы исключить попытку одновременного доступа. Если это невозможно, стоит использовать <code>Volatile</code> или <code>Interlocked</code>. Однако они подходят только для работы с простыми типами.</p><p>Две причины для блокирования потоков:</p><ul><li><strong>Упрощение модели программирования.</strong> Блокируя поток и жертвуя ресурсами, разработчик получает возможность писать код последовательно, без методов обратного вызова. Асинхронные функции C# предоставляют упрощённую модель программирования без необходимости блокировать потоки.</li><li><strong>Поток имеет определённое назначение.</strong></li></ul><p>Чтобы избежать блокировки потоков, не стоит мысленно связывать их с конкретными операциями. Потоки являются слишком ценным ресурсом, чтобы ограничивать их назначение. Стоит использовать пул потоков для возможности потокам решать разные задачи.</p><p>При блокировке для синхронизации потоков из разных доменов стоит использовать конструкции режима ядра. Стоит стараться избегать рекурсивных блокировок, так как они снижают производительность. Кроме того, стоит стараться не снимать блокировку в блоке <code>finally</code>, так как можно получить повреждённые данные.</p><p>В конечном счёте, для вычислительных операций или операций ввода-вывода стоит использовать асинхронные операции, так как они используют преимущества пула потоков.</p><h2 id="блокировка-с-двоинои-проверкои" tabindex="-1"><a class="header-anchor" href="#блокировка-с-двоинои-проверкои"><span>Блокировка с двойной проверкой</span></a></h2><p>К <em>блокировке с двойной проверкой</em> (double-check locking) прибегают, если нужно отложить создание <em>одиночки</em> (singletone) до тех пор, пока он не потребуется приложению - это называют <em>отложенной инициализацией</em> (lazy initialization). Это экономит время и память. Проблемы могут возникнуть если объект понадобится сразу нескольким потокам. Чтобы в результате появился только один объект, необходимо применить синхронизацию потоков. Пример реализации данной техники:</p><div class="language-csharp line-numbers-mode" data-ext="cs" data-title="cs"><pre class="language-csharp"><code><span class="token keyword">internal</span> <span class="token keyword">sealed</span> <span class="token keyword">class</span> <span class="token class-name">Singleton</span>
<span class="token punctuation">{</span>
  <span class="token comment">// Объект s_lock требуется для обеспечения безопасности в многопоточной среде.</span>
  <span class="token comment">// Наличие этого объекта предполагает, что для создания одноэлементного объекта требуется больше ресурсов,</span>
  <span class="token comment">// чем для объекта System.Object и что эта процедура может вовсе не понадобиться.</span>
  <span class="token comment">// В противном случае проще и эффективнее получить одноэлементный объект в конструкторе класса</span>
  <span class="token keyword">private</span> <span class="token keyword">static</span> <span class="token keyword">readonly</span> <span class="token class-name">Object</span> s_lock <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token constructor-invocation class-name">Object</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>

  <span class="token comment">// Это поле ссылается на один объект Singleton</span>
  <span class="token keyword">private</span> <span class="token keyword">static</span> <span class="token class-name">Singleton</span> s_value <span class="token operator">=</span> <span class="token keyword">null</span><span class="token punctuation">;</span>

  <span class="token comment">// Закрытый конструктор не дает внешнему коду создавать экземпляры</span>
  <span class="token keyword">private</span> <span class="token function">Singleton</span><span class="token punctuation">(</span><span class="token punctuation">)</span>
  <span class="token punctuation">{</span>
    <span class="token comment">// Код инициализации объекта Singleton</span>
  <span class="token punctuation">}</span>

  <span class="token comment">// Открытый статический метод, возвращающий объект Singleton (создавая его при необходимости)</span>
  <span class="token keyword">public</span> <span class="token keyword">static</span> <span class="token return-type class-name">Singleton</span> <span class="token function">GetSingleton</span><span class="token punctuation">(</span><span class="token punctuation">)</span>
  <span class="token punctuation">{</span>
    <span class="token comment">// Если объект Singleton уже создан, возвращаем его</span>
    <span class="token keyword">if</span> <span class="token punctuation">(</span>s_value <span class="token operator">!=</span> <span class="token keyword">null</span><span class="token punctuation">)</span> <span class="token keyword">return</span> s_value<span class="token punctuation">;</span>

    Monitor<span class="token punctuation">.</span><span class="token function">Enter</span><span class="token punctuation">(</span>s_lock<span class="token punctuation">)</span><span class="token punctuation">;</span> <span class="token comment">// Если не создан, позволяем одному потоку сделать это</span>
    <span class="token keyword">if</span> <span class="token punctuation">(</span>s_value <span class="token operator">==</span> <span class="token keyword">null</span><span class="token punctuation">)</span>
    <span class="token punctuation">{</span>
      <span class="token comment">// Если объекта все еще нет, создаем его</span>
      <span class="token class-name">Singleton</span> temp <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token constructor-invocation class-name">Singleton</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>

      <span class="token comment">// Сохраняем ссылку в переменной s_value (см. обсуждение далее)</span>
      Volatile<span class="token punctuation">.</span><span class="token function">Write</span><span class="token punctuation">(</span><span class="token keyword">ref</span> s_value<span class="token punctuation">,</span> temp<span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span>
    Monitor<span class="token punctuation">.</span><span class="token function">Exit</span><span class="token punctuation">(</span>s_lock<span class="token punctuation">)</span><span class="token punctuation">;</span>

    <span class="token comment">// Возвращаем ссылку на объект Singleton</span>
    <span class="token keyword">return</span> s_value<span class="token punctuation">;</span>
  <span class="token punctuation">}</span>
<span class="token punctuation">}</span>
</code></pre><div class="line-numbers" aria-hidden="true"><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div></div></div><p>Для многопоточной инициализации одиночки в FCL существует два типа <code>System.Lazy</code> и <code>System.Threading.LazyInitializer</code>.</p><h2 id="паттерн-условнои-переменнои" tabindex="-1"><a class="header-anchor" href="#паттерн-условнои-переменнои"><span>Паттерн условной переменной</span></a></h2><p>Если некий поток выполняет код при соблюдении сложного условия, то можно было бы просто организовать зацикливание этого потока с периодической проверкой условия, хотя этого не стоит делать по нескольким причинам:</p><ol><li>Пустая трата процессорного времени.</li><li>Невозможность атомарно проверить несколько переменных и условия.</li></ol><p>Решить эту проблему можно с использованием <em>паттерна условной переменной</em> (condition variable pattern):</p><div class="language-csharp line-numbers-mode" data-ext="cs" data-title="cs"><pre class="language-csharp"><code><span class="token keyword">internal</span> <span class="token keyword">sealed</span> <span class="token keyword">class</span> <span class="token class-name">ConditionVariablePattern</span>
<span class="token punctuation">{</span>
  <span class="token keyword">private</span> <span class="token keyword">readonly</span> <span class="token class-name">Object</span> m_lock <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token constructor-invocation class-name">Object</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
  <span class="token keyword">private</span> <span class="token class-name">Boolean</span> m_condition <span class="token operator">=</span> <span class="token boolean">false</span><span class="token punctuation">;</span>

  <span class="token keyword">public</span> <span class="token return-type class-name"><span class="token keyword">void</span></span> <span class="token function">Thread1</span><span class="token punctuation">(</span><span class="token punctuation">)</span>
  <span class="token punctuation">{</span>
    Monitor<span class="token punctuation">.</span><span class="token function">Enter</span><span class="token punctuation">(</span>m_lock<span class="token punctuation">)</span><span class="token punctuation">;</span> <span class="token comment">// Взаимоисключающая блокировка</span>

    <span class="token comment">// &quot;Атомарная&quot; проверка сложного условия блокирования</span>
    <span class="token keyword">while</span> <span class="token punctuation">(</span><span class="token operator">!</span>m_condition<span class="token punctuation">)</span>
    <span class="token punctuation">{</span>
      <span class="token comment">// Если условие не соблюдается, ждем, что его поменяет другой поток</span>
      Monitor<span class="token punctuation">.</span><span class="token function">Wait</span><span class="token punctuation">(</span>m_lock<span class="token punctuation">)</span><span class="token punctuation">;</span> <span class="token comment">// На время снимаем блокировку, чтобы другой поток мог ее получить</span>
    <span class="token punctuation">}</span>

    <span class="token comment">// Условие соблюдено, обрабатываем данные...</span>

    Monitor<span class="token punctuation">.</span><span class="token function">Exit</span><span class="token punctuation">(</span>m_lock<span class="token punctuation">)</span><span class="token punctuation">;</span> <span class="token comment">// Снятие блокировки</span>
  <span class="token punctuation">}</span>

  <span class="token keyword">public</span> <span class="token return-type class-name"><span class="token keyword">void</span></span> <span class="token function">Thread2</span><span class="token punctuation">(</span><span class="token punctuation">)</span>
  <span class="token punctuation">{</span>
    Monitor<span class="token punctuation">.</span><span class="token function">Enter</span><span class="token punctuation">(</span>m_lock<span class="token punctuation">)</span><span class="token punctuation">;</span> <span class="token comment">// Взаимоисключающая блокировка</span>

    <span class="token comment">// Обрабатываем данные и изменяем условие...</span>
    m_condition <span class="token operator">=</span> <span class="token boolean">true</span><span class="token punctuation">;</span>

    <span class="token comment">// Monitor.Pulse(m_lock); // Будим одного ожидающего ПОСЛЕ отмены блокировки</span>
    Monitor<span class="token punctuation">.</span><span class="token function">PulseAll</span><span class="token punctuation">(</span>m_lock<span class="token punctuation">)</span><span class="token punctuation">;</span> <span class="token comment">// Будим всех ожидающих ПОСЛЕ отмены блокировки</span>
    Monitor<span class="token punctuation">.</span><span class="token function">Exit</span><span class="token punctuation">(</span>m_lock<span class="token punctuation">)</span><span class="token punctuation">;</span> <span class="token comment">// Снятие блокировки</span>
  <span class="token punctuation">}</span>
<span class="token punctuation">}</span>
</code></pre><div class="line-numbers" aria-hidden="true"><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div></div></div><h2 id="асинхронная-синхронизация" tabindex="-1"><a class="header-anchor" href="#асинхронная-синхронизация"><span>Асинхронная синхронизация</span></a></h2><p>Конструкции синхронизации потоков, использующие примитивы в режиме ядра являются не лучшей идеей. Они нужны для блокирования потоков, в то время как создание потока обходится достаточно дорого, чтобы он потом бездействовал.</p><p>Многие из проблем, решаемых гибридными конструкциями, можно успешно решить с помощью <code>Task</code>. Такой подход имеет ряд преимуществ:</p><ul><li>Задания требуют меньше памяти, быстрее создаются и уничтожаются.</li><li>Пул потоков автоматически распределяет задания между доступными процессорами.</li><li>По мере завершения заданием своего этапа, выполнявший его поток возвращается в пул, где может заняться другой работой при наличии.</li><li>Пул потоков видит все задания и может лучше их планировать, сокращая количество потоков и переключений контекста.</li></ul><p>Несколько примеров асинхронной синхронизации:</p><ul><li><a href="https://learn.microsoft.com/ru-ru/dotnet/api/system.threading.semaphoreslim?view=net-8.0" target="_blank" rel="noopener noreferrer"><code>System.Threading.SemaphoreSlim</code><span><svg class="external-link-icon" xmlns="http://www.w3.org/2000/svg" aria-hidden="true" focusable="false" x="0px" y="0px" viewBox="0 0 100 100" width="15" height="15"><path fill="currentColor" d="M18.8,85.1h56l0,0c2.2,0,4-1.8,4-4v-32h-8v28h-48v-48h28v-8h-32l0,0c-2.2,0-4,1.8-4,4v56C14.8,83.3,16.6,85.1,18.8,85.1z"></path><polygon fill="currentColor" points="45.7,48.7 51.3,54.3 77.2,28.5 77.2,37.2 85.2,37.2 85.2,14.9 62.8,14.9 62.8,22.9 71.5,22.9"></polygon></svg><span class="external-link-icon-sr-only">open in new window</span></span></a> с использованием метода <code>WaitAsync()</code> решает проблему асинхронного ожидания получения потоком блокировки.</li><li><a href="https://learn.microsoft.com/en-us/dotnet/api/system.threading.tasks.concurrentexclusiveschedulerpair?view=net-8.0" target="_blank" rel="noopener noreferrer"><code>System.Threading.Tasks.ConcurrentExclusiveSchedulerPair</code> <span><svg class="external-link-icon" xmlns="http://www.w3.org/2000/svg" aria-hidden="true" focusable="false" x="0px" y="0px" viewBox="0 0 100 100" width="15" height="15"><path fill="currentColor" d="M18.8,85.1h56l0,0c2.2,0,4-1.8,4-4v-32h-8v28h-48v-48h28v-8h-32l0,0c-2.2,0-4,1.8-4,4v56C14.8,83.3,16.6,85.1,18.8,85.1z"></path><polygon fill="currentColor" points="45.7,48.7 51.3,54.3 77.2,28.5 77.2,37.2 85.2,37.2 85.2,14.9 62.8,14.9 62.8,22.9 71.5,22.9"></polygon></svg><span class="external-link-icon-sr-only">open in new window</span></span></a> позволяет реализовать семантику записи/чтения при планировании заданий.</li><li>В .NET нет асинхронных средств с семантикой чтения/записи, но Рихтер создал <code>AsyncOneManyLock</code>.</li></ul><h2 id="классы-коллекции-для-параллельного-доступа" tabindex="-1"><a class="header-anchor" href="#классы-коллекции-для-параллельного-доступа"><span>Классы коллекций для параллельного доступа</span></a></h2><p>В FCL существуют четыре потокобезопасных классов коллекций, принадлежащий пространству имён <code>System.Collections.Concurrent</code>: <code>ConcurrentQueue</code>, <code>ConcurrentStack</code>, <code>ConcurrentDictionary</code> и <code>ConcurrentBag</code>. Эти классы являются неблокирующими: при попытке извлечь несуществующий элемент поток немедленно возвращает управление, а не блокируется, ожидая появления элемента. Именно поэтому для получения используются методы <code>TryXXX()</code>, которые возвращают булево значение.</p><p>Хоть классы и являются неблокирующими, они могут использовать синхронизацию, пусть и на короткое время, необходимо для работы с элементами коллекции.</p><p>Все рассматриваемые классы обладают методом <code>GetEnumerator()</code>. Для всех классов кроме <code>ConcurrentDictionary</code> метод создаёт снимок (snapshot) и возвращает зафиксированные элементы, при этом коллекции могут поменяться.</p><p>Все классы кроме <code>ConcurrentDictionary</code> реализуют интерфейс <code>IProducerConsumerCollection</code>. Из-за этого классы могут стать блокирующими коллекциями: если коллекция заполнена, то блокируется пишущий поток, а если пуста - то читающий.</p></div><!--[--><!--]--></div><footer class="vp-page-meta"><div class="vp-meta-item edit-link"><a class="external-link label" href="https://github.com/arytry/clr-via-csharp/edit/main/docs/ru/chapters/ch30_hybridThreadSyncConst.md" rel="noopener noreferrer" target="_blank" aria-label="Edit this page"><!--[--><!--[--><svg class="icon" viewBox="0 0 1024 1024"><g fill="currentColor"><path d="M430.818 653.65a60.46 60.46 0 0 1-50.96-93.281l71.69-114.012 7.773-10.365L816.038 80.138A60.46 60.46 0 0 1 859.225 62a60.46 60.46 0 0 1 43.186 18.138l43.186 43.186a60.46 60.46 0 0 1 0 86.373L588.879 565.55l-8.637 8.637-117.466 68.234a60.46 60.46 0 0 1-31.958 11.229z"></path><path d="M728.802 962H252.891A190.883 190.883 0 0 1 62.008 771.98V296.934a190.883 190.883 0 0 1 190.883-192.61h267.754a60.46 60.46 0 0 1 0 120.92H252.891a69.962 69.962 0 0 0-69.098 69.099V771.98a69.962 69.962 0 0 0 69.098 69.098h475.911A69.962 69.962 0 0 0 797.9 771.98V503.363a60.46 60.46 0 1 1 120.922 0V771.98A190.883 190.883 0 0 1 728.802 962z"></path></g></svg><!--]--> Edit this page <span><svg class="external-link-icon" xmlns="http://www.w3.org/2000/svg" aria-hidden="true" focusable="false" x="0px" y="0px" viewBox="0 0 100 100" width="15" height="15"><path fill="currentColor" d="M18.8,85.1h56l0,0c2.2,0,4-1.8,4-4v-32h-8v28h-48v-48h28v-8h-32l0,0c-2.2,0-4,1.8-4,4v56C14.8,83.3,16.6,85.1,18.8,85.1z"></path><polygon fill="currentColor" points="45.7,48.7 51.3,54.3 77.2,28.5 77.2,37.2 85.2,37.2 85.2,14.9 62.8,14.9 62.8,22.9 71.5,22.9"></polygon></svg><span class="external-link-icon-sr-only">open in new window</span></span><!--[--><!--]--><!--]--></a></div><div class="vp-meta-item git-info"><div class="vp-meta-item last-updated"><span class="meta-item-label">Last Updated: </span><!----></div><!----></div></footer><nav class="vp-page-nav" aria-label="page navigation"><a class="route-link prev" href="/clr-via-csharp/ru/chapters/ch29_PrimitiveThreadSyncConstructs.html" aria-label="Примитивные конструкции синхронизации потоков"><!--[--><div class="hint"><span class="arrow left"></span> Prev</div><div class="link"><span>Примитивные конструкции синхронизации потоков</span></div><!--]--></a><!----></nav><!--[--><!--]--></main><!--]--></div><!--[--><!----><!--]--><!--]--></div>
    <script type="module" src="/clr-via-csharp/assets/app-IxoMmWNN.js" defer></script>
  </body>
</html>
