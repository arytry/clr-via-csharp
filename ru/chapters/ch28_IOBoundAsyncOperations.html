<!doctype html>
<html lang="ru-RU">
  <head>
    <meta charset="utf-8" />
    <meta name="viewport" content="width=device-width,initial-scale=1" />
    <meta name="generator" content="VuePress 2.0.0-rc.9" />
    <style>
      :root {
        --c-bg: #fff;
      }
      html.dark {
        --c-bg: #22272e;
      }
      html,
      body {
        background-color: var(--c-bg);
      }
    </style>
    <script>
      const userMode = localStorage.getItem('vuepress-color-scheme')
      const systemDarkMode =
        window.matchMedia &&
        window.matchMedia('(prefers-color-scheme: dark)').matches
      if (userMode === 'dark' || (userMode !== 'light' && systemDarkMode)) {
        document.documentElement.classList.toggle('dark', true)
      }
    </script>
    <link rel="icon" href="/assets/img/favicon.ico"><title>Асинхронные операции ввода-вывода | CLR via C#</title><meta name="description" content="CLR via C# Четвертое издание">
    <link rel="preload" href="/clr-via-csharp/assets/style-FaCSB-_p.css" as="style"><link rel="stylesheet" href="/clr-via-csharp/assets/style-FaCSB-_p.css">
    <link rel="modulepreload" href="/clr-via-csharp/assets/app-IxoMmWNN.js"><link rel="modulepreload" href="/clr-via-csharp/assets/ch28_IOBoundAsyncOperations.html-CwFR1TuA.js">
    <link rel="prefetch" href="/clr-via-csharp/assets/index.html-ZkH5qKEm.js" as="script"><link rel="prefetch" href="/clr-via-csharp/assets/index.html-BvaI8qfN.js" as="script"><link rel="prefetch" href="/clr-via-csharp/assets/Postscript.html-D-7172Jl.js" as="script"><link rel="prefetch" href="/clr-via-csharp/assets/ch01_TheCLRSExecutionMode.html-BLQSYEbL.js" as="script"><link rel="prefetch" href="/clr-via-csharp/assets/ch02_Building.html-Cmb5tXx5.js" as="script"><link rel="prefetch" href="/clr-via-csharp/assets/ch03_SharedAssemblies.html-C65m3L6w.js" as="script"><link rel="prefetch" href="/clr-via-csharp/assets/ch04_TypeFundamentals.html-MhrBc603.js" as="script"><link rel="prefetch" href="/clr-via-csharp/assets/ch05_PrimitiveRefValType.html-BExRN6IU.js" as="script"><link rel="prefetch" href="/clr-via-csharp/assets/ch06_TypeAndMemberBasics.html-Cwf82xZd.js" as="script"><link rel="prefetch" href="/clr-via-csharp/assets/ch07_ConstantsAndFields.html-U9jK40Ei.js" as="script"><link rel="prefetch" href="/clr-via-csharp/assets/ch08_Methods.html-CUDFuVYa.js" as="script"><link rel="prefetch" href="/clr-via-csharp/assets/ch09_Parameters.html-0oTJyJmn.js" as="script"><link rel="prefetch" href="/clr-via-csharp/assets/ch10_Properties.html-LLUaep7w.js" as="script"><link rel="prefetch" href="/clr-via-csharp/assets/ch11_Events.html-Bi9j89Ya.js" as="script"><link rel="prefetch" href="/clr-via-csharp/assets/ch12_Generics.html-Dbx7WK6o.js" as="script"><link rel="prefetch" href="/clr-via-csharp/assets/ch13_Interfaces.html-DsmoFQbF.js" as="script"><link rel="prefetch" href="/clr-via-csharp/assets/ch14_CharStringText.html-noMBAT3f.js" as="script"><link rel="prefetch" href="/clr-via-csharp/assets/ch15_EnumeratedTypes.html-MFb5H9zK.js" as="script"><link rel="prefetch" href="/clr-via-csharp/assets/ch16_Arrays.html-ZDLMr6H2.js" as="script"><link rel="prefetch" href="/clr-via-csharp/assets/ch17_Delegates.html-DYgFyOwD.js" as="script"><link rel="prefetch" href="/clr-via-csharp/assets/ch18_CustomAttributes.html-BtysPki2.js" as="script"><link rel="prefetch" href="/clr-via-csharp/assets/ch19_NullableValueTypes.html-CDUugoVg.js" as="script"><link rel="prefetch" href="/clr-via-csharp/assets/ch20_ExceptionsAndStateManae.html-BWeh_aT3.js" as="script"><link rel="prefetch" href="/clr-via-csharp/assets/ch21_ManagedHeapGarbage.html-CfeNN69i.js" as="script"><link rel="prefetch" href="/clr-via-csharp/assets/ch22_CLRHostingAndAppDomain.html-D16BElAb.js" as="script"><link rel="prefetch" href="/clr-via-csharp/assets/ch23_AssemblyLoaingReflection.html-DK1leolo.js" as="script"><link rel="prefetch" href="/clr-via-csharp/assets/ch24_RuntimeSerialization.html-CQ2ygEuE.js" as="script"><link rel="prefetch" href="/clr-via-csharp/assets/ch25_WinRTComponents.html-C3cvw10V.js" as="script"><link rel="prefetch" href="/clr-via-csharp/assets/ch26_ThreadBasics.html-CMPdATok.js" as="script"><link rel="prefetch" href="/clr-via-csharp/assets/ch27_ComputeBoundAsync.html-CTieDbCf.js" as="script"><link rel="prefetch" href="/clr-via-csharp/assets/ch28_IOBoundAsyncOperations.html-CJcp4OCy.js" as="script"><link rel="prefetch" href="/clr-via-csharp/assets/ch29_PrimitiveThreadSyncConstructs.html-CFsstSQQ.js" as="script"><link rel="prefetch" href="/clr-via-csharp/assets/ch30_hybridThreadSyncConst.html-beZI77Lv.js" as="script"><link rel="prefetch" href="/clr-via-csharp/assets/foreword.html-Bi67Yt5h.js" as="script"><link rel="prefetch" href="/clr-via-csharp/assets/introduction.html-dvExR8Gk.js" as="script"><link rel="prefetch" href="/clr-via-csharp/assets/index.html-GDcN_xMH.js" as="script"><link rel="prefetch" href="/clr-via-csharp/assets/ch01_TheCLRSExecutionMode.html-BwKxRLwh.js" as="script"><link rel="prefetch" href="/clr-via-csharp/assets/ch02_Building.html-BMQPeoI2.js" as="script"><link rel="prefetch" href="/clr-via-csharp/assets/ch03_SharedAssemblies.html-27zHcXlW.js" as="script"><link rel="prefetch" href="/clr-via-csharp/assets/ch04_TypeFundamentals.html-CVDf2x4Y.js" as="script"><link rel="prefetch" href="/clr-via-csharp/assets/ch05_PrimitiveRefValType.html-DkaxxntM.js" as="script"><link rel="prefetch" href="/clr-via-csharp/assets/ch06_TypeAndMemberBasics.html-BGwRCWdf.js" as="script"><link rel="prefetch" href="/clr-via-csharp/assets/ch07_ConstantsAndFields.html-D2jgyLeB.js" as="script"><link rel="prefetch" href="/clr-via-csharp/assets/ch08_Methods.html-CcZqtO9s.js" as="script"><link rel="prefetch" href="/clr-via-csharp/assets/ch09_Parameters.html-Cgf_mCwx.js" as="script"><link rel="prefetch" href="/clr-via-csharp/assets/ch10_Properties.html-CO8XAMmW.js" as="script"><link rel="prefetch" href="/clr-via-csharp/assets/ch11_Events.html-DZ5a5JQg.js" as="script"><link rel="prefetch" href="/clr-via-csharp/assets/ch12_Generics.html-D0mGmkov.js" as="script"><link rel="prefetch" href="/clr-via-csharp/assets/ch13_Interfaces.html-BGdd7LBY.js" as="script"><link rel="prefetch" href="/clr-via-csharp/assets/ch14_CharStringText.html-DExRFCv1.js" as="script"><link rel="prefetch" href="/clr-via-csharp/assets/ch15_EnumeratedTypes.html-BiTZ-5od.js" as="script"><link rel="prefetch" href="/clr-via-csharp/assets/ch16_Arrays.html-Dsjpqw47.js" as="script"><link rel="prefetch" href="/clr-via-csharp/assets/ch17_Delegates.html-DWEP33D9.js" as="script"><link rel="prefetch" href="/clr-via-csharp/assets/ch18_CustomAttributes.html-DtaR-VvP.js" as="script"><link rel="prefetch" href="/clr-via-csharp/assets/ch19_NullableValueTypes.html-CvrkASkk.js" as="script"><link rel="prefetch" href="/clr-via-csharp/assets/ch20_ExceptionsAndStateManae.html-BuN-nGuz.js" as="script"><link rel="prefetch" href="/clr-via-csharp/assets/ch21_ManagedHeapGarbage.html-f0AOnmUF.js" as="script"><link rel="prefetch" href="/clr-via-csharp/assets/ch22_CLRHostingAndAppDomain.html-C4pcwqj-.js" as="script"><link rel="prefetch" href="/clr-via-csharp/assets/ch23_AssemblyLoaingReflection.html-CHZCU__5.js" as="script"><link rel="prefetch" href="/clr-via-csharp/assets/ch24_RuntimeSerialization.html-emd0r8wc.js" as="script"><link rel="prefetch" href="/clr-via-csharp/assets/ch25_WinRTComponents.html-BmMk3Oqy.js" as="script"><link rel="prefetch" href="/clr-via-csharp/assets/ch26_ThreadBasics.html-DDuBq2h_.js" as="script"><link rel="prefetch" href="/clr-via-csharp/assets/ch27_ComputeBoundAsync.html-DXXfHTUn.js" as="script"><link rel="prefetch" href="/clr-via-csharp/assets/ch29_PrimitiveThreadSyncConstructs.html-Bjaf8DNA.js" as="script"><link rel="prefetch" href="/clr-via-csharp/assets/ch30_hybridThreadSyncConst.html-D2MW45gx.js" as="script"><link rel="prefetch" href="/clr-via-csharp/assets/Postscript.html-Bpkc--tR.js" as="script"><link rel="prefetch" href="/clr-via-csharp/assets/ch01_TheCLRSExecutionMode.html-BPnkWvJ8.js" as="script"><link rel="prefetch" href="/clr-via-csharp/assets/ch02_Building.html-q0yDwRpt.js" as="script"><link rel="prefetch" href="/clr-via-csharp/assets/ch03_SharedAssemblies.html-BjqQ7sdC.js" as="script"><link rel="prefetch" href="/clr-via-csharp/assets/ch04_TypeFundamentals.html-BIIy8leD.js" as="script"><link rel="prefetch" href="/clr-via-csharp/assets/ch05_PrimitiveRefValType.html-BOo-9fso.js" as="script"><link rel="prefetch" href="/clr-via-csharp/assets/ch06_TypeAndMemberBasics.html-DzDrvZ87.js" as="script"><link rel="prefetch" href="/clr-via-csharp/assets/ch07_ConstantsAndFields.html-CASmG777.js" as="script"><link rel="prefetch" href="/clr-via-csharp/assets/ch08_Methods.html-CEM163Qb.js" as="script"><link rel="prefetch" href="/clr-via-csharp/assets/ch09_Parameters.html-BkR6SOXn.js" as="script"><link rel="prefetch" href="/clr-via-csharp/assets/ch10_Properties.html-sfPfXudR.js" as="script"><link rel="prefetch" href="/clr-via-csharp/assets/ch11_Events.html-LJfkVvEp.js" as="script"><link rel="prefetch" href="/clr-via-csharp/assets/ch12_Generics.html-CSXiWNpq.js" as="script"><link rel="prefetch" href="/clr-via-csharp/assets/ch13_Interfaces.html-CBasocgy.js" as="script"><link rel="prefetch" href="/clr-via-csharp/assets/ch14_CharStringText.html-o4yS52Dy.js" as="script"><link rel="prefetch" href="/clr-via-csharp/assets/ch15_EnumeratedTypes.html-BZtqvWYE.js" as="script"><link rel="prefetch" href="/clr-via-csharp/assets/ch16_Arrays.html-CGp-_Jrw.js" as="script"><link rel="prefetch" href="/clr-via-csharp/assets/ch17_Delegates.html-tcKP_pXy.js" as="script"><link rel="prefetch" href="/clr-via-csharp/assets/ch18_CustomAttributes.html-B6RvN9hy.js" as="script"><link rel="prefetch" href="/clr-via-csharp/assets/ch19_NullableValueTypes.html-BkMiV6yx.js" as="script"><link rel="prefetch" href="/clr-via-csharp/assets/ch20_ExceptionsAndStateManae.html-BsTwrSmr.js" as="script"><link rel="prefetch" href="/clr-via-csharp/assets/ch21_ManagedHeapGarbage.html-BDn6rSrD.js" as="script"><link rel="prefetch" href="/clr-via-csharp/assets/ch22_CLRHostingAndAppDomain.html-Bi_35IQj.js" as="script"><link rel="prefetch" href="/clr-via-csharp/assets/ch23_AssemblyLoaingReflection.html-stJPEo8t.js" as="script"><link rel="prefetch" href="/clr-via-csharp/assets/ch24_RuntimeSerialization.html-BexV0ImS.js" as="script"><link rel="prefetch" href="/clr-via-csharp/assets/ch25_WinRTComponents.html-Cw_fsfmx.js" as="script"><link rel="prefetch" href="/clr-via-csharp/assets/ch26_ThreadBasics.html-QnhhtSZl.js" as="script"><link rel="prefetch" href="/clr-via-csharp/assets/ch27_ComputeBoundAsync.html-DNJcQUkI.js" as="script"><link rel="prefetch" href="/clr-via-csharp/assets/ch28_IOBoundAsyncOperations.html-BAwtWkjU.js" as="script"><link rel="prefetch" href="/clr-via-csharp/assets/ch29_PrimitiveThreadSyncConstructs.html-5-bQNQmT.js" as="script"><link rel="prefetch" href="/clr-via-csharp/assets/ch30_hybridThreadSyncConst.html-DKmbpj4c.js" as="script"><link rel="prefetch" href="/clr-via-csharp/assets/foreword.html-GASyXvmd.js" as="script"><link rel="prefetch" href="/clr-via-csharp/assets/introduction.html-D6bO62ut.js" as="script"><link rel="prefetch" href="/clr-via-csharp/assets/404.html-5gOqppNC.js" as="script">
  </head>
  <body>
    <div id="app"><!--[--><div class="theme-container"><!--[--><header class="navbar"><div class="toggle-sidebar-button" title="toggle sidebar" aria-expanded="false" role="button" tabindex="0"><div class="icon" aria-hidden="true"><span></span><span></span><span></span></div></div><span><a class="route-link" href="/clr-via-csharp/ru/"><img class="logo" src="/clr-via-csharp/assets/images/cover.jpg" alt="CLR via C#"><span class="site-name can-hide" aria-hidden="true">CLR via C#</span></a></span><div class="navbar-items-wrapper" style=""><!--[--><!--]--><nav class="navbar-items can-hide" aria-label="site navigation"><!--[--><div class="navbar-item"><div class="navbar-dropdown-wrapper"><button class="navbar-dropdown-title" type="button" aria-label="Select language"><span class="title">Выберите язык</span><span class="arrow down"></span></button><button class="navbar-dropdown-title-mobile" type="button" aria-label="Select language"><span class="title">Выберите язык</span><span class="right arrow"></span></button><ul style="display:none;" class="navbar-dropdown"><!--[--><li class="navbar-dropdown-item"><a class="route-link" href="/clr-via-csharp/chapters/ch28_IOBoundAsyncOperations.html" aria-label="简体中文"><!--[--><!--[--><!--]--> 简体中文 <!--[--><!--]--><!--]--></a></li><li class="navbar-dropdown-item"><a class="route-link route-link-active" href="/clr-via-csharp/" aria-label="Русский"><!--[--><!--[--><!--]--> Русский <!--[--><!--]--><!--]--></a></li><!--]--></ul></div></div><div class="navbar-item"><a class="external-link" href="https://github.com/arytry/clr-via-csharp" rel="noopener noreferrer" target="_blank" aria-label="GitHub"><!--[--><!--[--><!--]--> GitHub <span><svg class="external-link-icon" xmlns="http://www.w3.org/2000/svg" aria-hidden="true" focusable="false" x="0px" y="0px" viewBox="0 0 100 100" width="15" height="15"><path fill="currentColor" d="M18.8,85.1h56l0,0c2.2,0,4-1.8,4-4v-32h-8v28h-48v-48h28v-8h-32l0,0c-2.2,0-4,1.8-4,4v56C14.8,83.3,16.6,85.1,18.8,85.1z"></path><polygon fill="currentColor" points="45.7,48.7 51.3,54.3 77.2,28.5 77.2,37.2 85.2,37.2 85.2,14.9 62.8,14.9 62.8,22.9 71.5,22.9"></polygon></svg><span class="external-link-icon-sr-only">open in new window</span></span><!--[--><!--]--><!--]--></a></div><!--]--></nav><!--[--><!--]--><button class="toggle-color-mode-button" title="toggle color mode"><svg style="" class="icon" focusable="false" viewBox="0 0 32 32"><path d="M16 12.005a4 4 0 1 1-4 4a4.005 4.005 0 0 1 4-4m0-2a6 6 0 1 0 6 6a6 6 0 0 0-6-6z" fill="currentColor"></path><path d="M5.394 6.813l1.414-1.415l3.506 3.506L8.9 10.318z" fill="currentColor"></path><path d="M2 15.005h5v2H2z" fill="currentColor"></path><path d="M5.394 25.197L8.9 21.691l1.414 1.415l-3.506 3.505z" fill="currentColor"></path><path d="M15 25.005h2v5h-2z" fill="currentColor"></path><path d="M21.687 23.106l1.414-1.415l3.506 3.506l-1.414 1.414z" fill="currentColor"></path><path d="M25 15.005h5v2h-5z" fill="currentColor"></path><path d="M21.687 8.904l3.506-3.506l1.414 1.415l-3.506 3.505z" fill="currentColor"></path><path d="M15 2.005h2v5h-2z" fill="currentColor"></path></svg><svg style="display:none;" class="icon" focusable="false" viewBox="0 0 32 32"><path d="M13.502 5.414a15.075 15.075 0 0 0 11.594 18.194a11.113 11.113 0 0 1-7.975 3.39c-.138 0-.278.005-.418 0a11.094 11.094 0 0 1-3.2-21.584M14.98 3a1.002 1.002 0 0 0-.175.016a13.096 13.096 0 0 0 1.825 25.981c.164.006.328 0 .49 0a13.072 13.072 0 0 0 10.703-5.555a1.01 1.01 0 0 0-.783-1.565A13.08 13.08 0 0 1 15.89 4.38A1.015 1.015 0 0 0 14.98 3z" fill="currentColor"></path></svg></button><!----></div></header><!--]--><div class="sidebar-mask"></div><!--[--><aside class="sidebar"><nav class="navbar-items" aria-label="site navigation"><!--[--><div class="navbar-item"><div class="navbar-dropdown-wrapper"><button class="navbar-dropdown-title" type="button" aria-label="Select language"><span class="title">Выберите язык</span><span class="arrow down"></span></button><button class="navbar-dropdown-title-mobile" type="button" aria-label="Select language"><span class="title">Выберите язык</span><span class="right arrow"></span></button><ul style="display:none;" class="navbar-dropdown"><!--[--><li class="navbar-dropdown-item"><a class="route-link" href="/clr-via-csharp/chapters/ch28_IOBoundAsyncOperations.html" aria-label="简体中文"><!--[--><!--[--><!--]--> 简体中文 <!--[--><!--]--><!--]--></a></li><li class="navbar-dropdown-item"><a class="route-link route-link-active" href="/clr-via-csharp/" aria-label="Русский"><!--[--><!--[--><!--]--> Русский <!--[--><!--]--><!--]--></a></li><!--]--></ul></div></div><div class="navbar-item"><a class="external-link" href="https://github.com/arytry/clr-via-csharp" rel="noopener noreferrer" target="_blank" aria-label="GitHub"><!--[--><!--[--><!--]--> GitHub <span><svg class="external-link-icon" xmlns="http://www.w3.org/2000/svg" aria-hidden="true" focusable="false" x="0px" y="0px" viewBox="0 0 100 100" width="15" height="15"><path fill="currentColor" d="M18.8,85.1h56l0,0c2.2,0,4-1.8,4-4v-32h-8v28h-48v-48h28v-8h-32l0,0c-2.2,0-4,1.8-4,4v56C14.8,83.3,16.6,85.1,18.8,85.1z"></path><polygon fill="currentColor" points="45.7,48.7 51.3,54.3 77.2,28.5 77.2,37.2 85.2,37.2 85.2,14.9 62.8,14.9 62.8,22.9 71.5,22.9"></polygon></svg><span class="external-link-icon-sr-only">open in new window</span></span><!--[--><!--]--><!--]--></a></div><!--]--></nav><!--[--><!--]--><ul class="sidebar-items"><!--[--><li><a class="route-link sidebar-item sidebar-heading" href="/clr-via-csharp/ru/chapters/ch01_TheCLRSExecutionMode.html" aria-label="Модель выполнения кода в среде CLR"><!--[--><!--[--><!--]--> Модель выполнения кода в среде CLR <!--[--><!--]--><!--]--></a><!----></li><li><a class="route-link sidebar-item sidebar-heading" href="/clr-via-csharp/ru/chapters/ch02_Building.html" aria-label="Компоновка, упаковка, развёртывание и администрирование приложений и типов"><!--[--><!--[--><!--]--> Компоновка, упаковка, развёртывание и администрирование приложений и типов <!--[--><!--]--><!--]--></a><!----></li><li><a class="route-link sidebar-item sidebar-heading" href="/clr-via-csharp/ru/chapters/ch03_SharedAssemblies.html" aria-label="Совместно используемые сборки и сборки со строгим именем"><!--[--><!--[--><!--]--> Совместно используемые сборки и сборки со строгим именем <!--[--><!--]--><!--]--></a><!----></li><li><a class="route-link sidebar-item sidebar-heading" href="/clr-via-csharp/ru/chapters/ch04_TypeFundamentals.html" aria-label="Основы типов"><!--[--><!--[--><!--]--> Основы типов <!--[--><!--]--><!--]--></a><!----></li><li><a class="route-link sidebar-item sidebar-heading" href="/clr-via-csharp/ru/chapters/ch05_PrimitiveRefValType.html" aria-label="Примитивные, ссылочные и значимые типы"><!--[--><!--[--><!--]--> Примитивные, ссылочные и значимые типы <!--[--><!--]--><!--]--></a><!----></li><li><a class="route-link sidebar-item sidebar-heading" href="/clr-via-csharp/ru/chapters/ch06_TypeAndMemberBasics.html" aria-label="Основные сведения о членах и типах"><!--[--><!--[--><!--]--> Основные сведения о членах и типах <!--[--><!--]--><!--]--></a><!----></li><li><a class="route-link sidebar-item sidebar-heading" href="/clr-via-csharp/ru/chapters/ch07_ConstantsAndFields.html" aria-label="Константы и поля"><!--[--><!--[--><!--]--> Константы и поля <!--[--><!--]--><!--]--></a><!----></li><li><a class="route-link sidebar-item sidebar-heading" href="/clr-via-csharp/ru/chapters/ch08_Methods.html" aria-label="Методы"><!--[--><!--[--><!--]--> Методы <!--[--><!--]--><!--]--></a><!----></li><li><a class="route-link sidebar-item sidebar-heading" href="/clr-via-csharp/ru/chapters/ch09_Parameters.html" aria-label="Параметры"><!--[--><!--[--><!--]--> Параметры <!--[--><!--]--><!--]--></a><!----></li><li><a class="route-link sidebar-item sidebar-heading" href="/clr-via-csharp/ru/chapters/ch10_Properties.html" aria-label="Свойства"><!--[--><!--[--><!--]--> Свойства <!--[--><!--]--><!--]--></a><!----></li><li><a class="route-link sidebar-item sidebar-heading" href="/clr-via-csharp/ru/chapters/ch11_Events.html" aria-label="События"><!--[--><!--[--><!--]--> События <!--[--><!--]--><!--]--></a><!----></li><li><a class="route-link sidebar-item sidebar-heading" href="/clr-via-csharp/ru/chapters/ch12_Generics.html" aria-label="Обобщения"><!--[--><!--[--><!--]--> Обобщения <!--[--><!--]--><!--]--></a><!----></li><li><a class="route-link sidebar-item sidebar-heading" href="/clr-via-csharp/ru/chapters/ch13_Interfaces.html" aria-label="Интерфейсы"><!--[--><!--[--><!--]--> Интерфейсы <!--[--><!--]--><!--]--></a><!----></li><li><a class="route-link sidebar-item sidebar-heading" href="/clr-via-csharp/ru/chapters/ch14_CharStringText.html" aria-label="Символы, строки и обработка текста"><!--[--><!--[--><!--]--> Символы, строки и обработка текста <!--[--><!--]--><!--]--></a><!----></li><li><a class="route-link sidebar-item sidebar-heading" href="/clr-via-csharp/ru/chapters/ch15_EnumeratedTypes.html" aria-label="Перечислимые типы и битовые флаги"><!--[--><!--[--><!--]--> Перечислимые типы и битовые флаги <!--[--><!--]--><!--]--></a><!----></li><li><a class="route-link sidebar-item sidebar-heading" href="/clr-via-csharp/ru/chapters/ch16_Arrays.html" aria-label="Массивы"><!--[--><!--[--><!--]--> Массивы <!--[--><!--]--><!--]--></a><!----></li><li><a class="route-link sidebar-item sidebar-heading" href="/clr-via-csharp/ru/chapters/ch17_Delegates.html" aria-label="Делегаты"><!--[--><!--[--><!--]--> Делегаты <!--[--><!--]--><!--]--></a><!----></li><li><a class="route-link sidebar-item sidebar-heading" href="/clr-via-csharp/ru/chapters/ch18_CustomAttributes.html" aria-label="Настраиваемые атрибуты"><!--[--><!--[--><!--]--> Настраиваемые атрибуты <!--[--><!--]--><!--]--></a><!----></li><li><a class="route-link sidebar-item sidebar-heading" href="/clr-via-csharp/ru/chapters/ch19_NullableValueTypes.html" aria-label="Null-совместимые значимые типы"><!--[--><!--[--><!--]--> Null-совместимые значимые типы <!--[--><!--]--><!--]--></a><!----></li><li><a class="route-link sidebar-item sidebar-heading" href="/clr-via-csharp/ru/chapters/ch20_ExceptionsAndStateManae.html" aria-label="Исключения и управление состоянием"><!--[--><!--[--><!--]--> Исключения и управление состоянием <!--[--><!--]--><!--]--></a><!----></li><li><a class="route-link sidebar-item sidebar-heading" href="/clr-via-csharp/ru/chapters/ch21_ManagedHeapGarbage.html" aria-label="Автоматическое управление памятью (сборка мусора)"><!--[--><!--[--><!--]--> Автоматическое управление памятью (сборка мусора) <!--[--><!--]--><!--]--></a><!----></li><li><a class="route-link sidebar-item sidebar-heading" href="/clr-via-csharp/ru/chapters/ch22_CLRHostingAndAppDomain.html" aria-label="Хостинг CLR и домены приложений"><!--[--><!--[--><!--]--> Хостинг CLR и домены приложений <!--[--><!--]--><!--]--></a><!----></li><li><a class="route-link sidebar-item sidebar-heading" href="/clr-via-csharp/ru/chapters/ch23_AssemblyLoaingReflection.html" aria-label="Загрузка сборок и отражение"><!--[--><!--[--><!--]--> Загрузка сборок и отражение <!--[--><!--]--><!--]--></a><!----></li><li><a class="route-link sidebar-item sidebar-heading" href="/clr-via-csharp/ru/chapters/ch24_RuntimeSerialization.html" aria-label="Сериализация"><!--[--><!--[--><!--]--> Сериализация <!--[--><!--]--><!--]--></a><!----></li><li><a class="route-link sidebar-item sidebar-heading" href="/clr-via-csharp/ru/chapters/ch25_WinRTComponents.html" aria-label="Взаимодействие с компонентами WinRT"><!--[--><!--[--><!--]--> Взаимодействие с компонентами WinRT <!--[--><!--]--><!--]--></a><!----></li><li><a class="route-link sidebar-item sidebar-heading" href="/clr-via-csharp/ru/chapters/ch26_ThreadBasics.html" aria-label="Потоки исполнения"><!--[--><!--[--><!--]--> Потоки исполнения <!--[--><!--]--><!--]--></a><!----></li><li><a class="route-link sidebar-item sidebar-heading" href="/clr-via-csharp/ru/chapters/ch27_ComputeBoundAsync.html" aria-label="Асинхронные вычислительные операции"><!--[--><!--[--><!--]--> Асинхронные вычислительные операции <!--[--><!--]--><!--]--></a><!----></li><li><a class="route-link route-link-active sidebar-item sidebar-heading active" href="/clr-via-csharp/ru/chapters/ch28_IOBoundAsyncOperations.html" aria-label="Асинхронные операции ввода-вывода"><!--[--><!--[--><!--]--> Асинхронные операции ввода-вывода <!--[--><!--]--><!--]--></a><ul style="" class="sidebar-item-children"><!--[--><li><a class="route-link sidebar-item" href="#операции-ввода-вывода-в-windows" aria-label="Операции ввода-вывода в Windows"><!--[--><!--[--><!--]--> Операции ввода-вывода в Windows <!--[--><!--]--><!--]--></a><!----></li><li><a class="route-link sidebar-item" href="#асинхронные-функции-c" aria-label="Асинхронные функции C#"><!--[--><!--[--><!--]--> Асинхронные функции C# <!--[--><!--]--><!--]--></a><!----></li><li><a class="route-link sidebar-item" href="#преобразование-асинхроннои-функции-в-конечныи-автомат" aria-label="Преобразование асинхронной функции в конечный автомат"><!--[--><!--[--><!--]--> Преобразование асинхронной функции в конечный автомат <!--[--><!--]--><!--]--></a><!----></li><li><a class="route-link sidebar-item" href="#расширяемость-асинхронных-функции" aria-label="Расширяемость асинхронных функций"><!--[--><!--[--><!--]--> Расширяемость асинхронных функций <!--[--><!--]--><!--]--></a><!----></li><li><a class="route-link sidebar-item" href="#асинхронные-функции-и-обработчики-событии" aria-label="Асинхронные функции и обработчики событий"><!--[--><!--[--><!--]--> Асинхронные функции и обработчики событий <!--[--><!--]--><!--]--></a><!----></li><li><a class="route-link sidebar-item" href="#асинхронные-функции-fcl" aria-label="Асинхронные функции FCL"><!--[--><!--[--><!--]--> Асинхронные функции FCL <!--[--><!--]--><!--]--></a><!----></li><li><a class="route-link sidebar-item" href="#асинхронные-функции-и-исключения" aria-label="Асинхронные функции и исключения"><!--[--><!--[--><!--]--> Асинхронные функции и исключения <!--[--><!--]--><!--]--></a><!----></li><li><a class="route-link sidebar-item" href="#другие-возможности-асинхронных-функции" aria-label="Другие возможности асинхронных функций"><!--[--><!--[--><!--]--> Другие возможности асинхронных функций <!--[--><!--]--><!--]--></a><!----></li><li><a class="route-link sidebar-item" href="#потоковые-модели-приложении" aria-label="Потоковые модели приложений"><!--[--><!--[--><!--]--> Потоковые модели приложений <!--[--><!--]--><!--]--></a><!----></li><li><a class="route-link sidebar-item" href="#асинхронная-реализация-сервера" aria-label="Асинхронная реализация сервера"><!--[--><!--[--><!--]--> Асинхронная реализация сервера <!--[--><!--]--><!--]--></a><!----></li><li><a class="route-link sidebar-item" href="#отмена-операции-ввода-вывода" aria-label="Отмена операций ввода-вывода"><!--[--><!--[--><!--]--> Отмена операций ввода-вывода <!--[--><!--]--><!--]--></a><ul style="" class="sidebar-item-children"><!--[--><li><a class="route-link sidebar-item" href="#некоторые-операции-ввода-вывода-должны-выполняться-синхронно" aria-label="Некоторые операции ввода-вывода должны выполняться синхронно"><!--[--><!--[--><!--]--> Некоторые операции ввода-вывода должны выполняться синхронно <!--[--><!--]--><!--]--></a><!----></li><li><a class="route-link sidebar-item" href="#проблемы-filestream" aria-label="Проблемы FileStream"><!--[--><!--[--><!--]--> Проблемы FileStream <!--[--><!--]--><!--]--></a><!----></li><!--]--></ul></li><li><a class="route-link sidebar-item" href="#приоритеты-запросов-ввода-вывода" aria-label="Приоритеты запросов ввода-вывода"><!--[--><!--[--><!--]--> Приоритеты запросов ввода-вывода <!--[--><!--]--><!--]--></a><!----></li><!--]--></ul></li><li><a class="route-link sidebar-item sidebar-heading" href="/clr-via-csharp/ru/chapters/ch29_PrimitiveThreadSyncConstructs.html" aria-label="Примитивные конструкции синхронизации потоков"><!--[--><!--[--><!--]--> Примитивные конструкции синхронизации потоков <!--[--><!--]--><!--]--></a><!----></li><li><a class="route-link sidebar-item sidebar-heading" href="/clr-via-csharp/ru/chapters/ch30_hybridThreadSyncConst.html" aria-label="Гибридные конструкции синхронизации потоков"><!--[--><!--[--><!--]--> Гибридные конструкции синхронизации потоков <!--[--><!--]--><!--]--></a><!----></li><!--]--></ul><!--[--><!--]--></aside><!--]--><!--[--><main class="page"><!--[--><!--]--><div class="theme-default-content"><!--[--><!--]--><div><h1 id="асинхронные-операции-ввода-вывода" tabindex="-1"><a class="header-anchor" href="#асинхронные-операции-ввода-вывода"><span>Асинхронные операции ввода-вывода</span></a></h1><h2 id="операции-ввода-вывода-в-windows" tabindex="-1"><a class="header-anchor" href="#операции-ввода-вывода-в-windows"><span>Операции ввода-вывода в Windows</span></a></h2><p>В процессе выполнения устройством операции ввода-вывода поток исполнения, передавший запрос, простаивает, поэтому Windows переводит его в спящее состояние, чтобы не расходовать процессорное время. Однако при этом поток продолжает занимать место в памяти своими структурами. После завершение операции ввода-выводы Windows пробуждает поток, ставит его в очередь процессора.</p><p>Можно представить реализацию веб-приложения, в которой для каждого пришедшего на сервер клиентского запроса формируется запрос к базе данных. В случае синхронного запроса к базе поток из пула окажется заблокированным на время, необходимое для чтения данных из базы. Если в это время придёт ещё один клиентский запрос, пул создаст новый поток. Таким образом потребление ресурсов продолжит расти. Проблема усугубится тем, что при получении результатов из базы несколько потоков могут разблокироваться одновременно, и их число может оказаться выше числа процессоров, что приведёт к частым переключениям контекста.</p><p><img src="https://github.com/kuzmin-nikita/CLR-via-CSharp/assets/80389873/dac07c85-dd6f-4cd7-94ca-8581c701ccae" alt="image"></p><p>В качестве альтернативы есть способ асинхронного чтения данных.</p><p><img src="https://github.com/kuzmin-nikita/CLR-via-CSharp/assets/80389873/52e54376-8863-4dda-be4e-7cf1c3274339" alt="image"></p><p>В случае асинхронных операций ввода-вывода в веб-приложении поток не блокируется, а возвращается в пул и может заняться обработкой других клиентский запросов. В этом случае все запросы может обработать один поток. Полученный от базы ответ окажется в очереди пула потоков, то есть его обработает тот же поток. Если элементы в пуле будут появляться быстрее, чем поток сможет их обработать, пул быстро создаст по одному потоку на каждый процессор.</p><p>Однако при блокировке потока (выполнение синхронной операции ввода-вывода, вызове метода <code>Thread.Sleep()</code> или ожидании, связанном с блокировкой потока в рамках синхронизации) пул будет уведомлен, что один из потоков прекратил работу. В этом случае создастся дополнительный поток взамен заблокированного, что приведёт к дополнительным затратам времени и памяти. Кроме того, позднее поток может быть разблокирован и процессор окажется перегруженным, провоцируя частые переключения контекста. Эта проблема решается средствами пула. Завершившим и вернувшимся в пул потокам не дают обрабатывать новые элементы, пока загрузка процессора не достигнет определённого уровня. Если впоследствии выяснится, что потоков больше, чем нужно, лишние самоуничтожатся.</p><p>Асинхронный ввод-вывод предоставляет и другие преимущества. CLR в начале сборки мусора приостанавливает все потоки, следовательно, чем меньше потоков, тем быстрее произойдёт сборка мусора. Также при сборке будет просматриваться меньше стеков потоков. Также если потоки не были заблокированы, то они окажутся в пуле наверху стека, и поиск корней не займёт много времени. По аналогичным же причинам ускоряется и отладка приложений.</p><h2 id="асинхронные-функции-c" tabindex="-1"><a class="header-anchor" href="#асинхронные-функции-c"><span>Асинхронные функции C#</span></a></h2><p>Асинхронные операции являются ключом к созданию высокопроизводительных масштабируемых приложений, выполняющих множество операций при помощи небольшого числа потоков. Вместе с пулом потоков они позволяют эффективно задействовать все процессоры в системе. Для этого разработчики CLR разработали модель программирования, основанную на <code>Task</code> и <em>асинхронных функциях</em> языка C#.</p><div class="language-csharp line-numbers-mode" data-ext="cs" data-title="cs"><pre class="language-csharp"><code><span class="token keyword">private</span> <span class="token keyword">static</span> <span class="token keyword">async</span> <span class="token return-type class-name">Task<span class="token punctuation">&lt;</span>String<span class="token punctuation">&gt;</span></span> <span class="token function">IssueClientRequestAsync</span><span class="token punctuation">(</span><span class="token class-name">String</span> serverName<span class="token punctuation">,</span> <span class="token class-name">String</span> message<span class="token punctuation">)</span>
<span class="token punctuation">{</span>
  <span class="token keyword">using</span> <span class="token punctuation">(</span><span class="token class-name"><span class="token keyword">var</span></span> pipe <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token constructor-invocation class-name">NamedPipeClientStream</span><span class="token punctuation">(</span>serverName<span class="token punctuation">,</span> <span class="token string">&quot;PipeName&quot;</span><span class="token punctuation">,</span> PipeDirection<span class="token punctuation">.</span>InOut<span class="token punctuation">,</span> PipeOptions<span class="token punctuation">.</span>Asynchronous <span class="token operator">|</span> PipeOptions<span class="token punctuation">.</span>WriteThrough<span class="token punctuation">)</span><span class="token punctuation">)</span>
  <span class="token punctuation">{</span>
    pipe<span class="token punctuation">.</span><span class="token function">Connect</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span> <span class="token comment">// Прежде чем задавать ReadMode, необходимо</span>
    pipe<span class="token punctuation">.</span>ReadMode <span class="token operator">=</span> PipeTransmissionMode<span class="token punctuation">.</span>Message<span class="token punctuation">;</span> <span class="token comment">// вызвать Connect</span>

    <span class="token comment">// Асинхронная отправка данных серверу</span>
    <span class="token class-name">Byte<span class="token punctuation">[</span><span class="token punctuation">]</span></span> request <span class="token operator">=</span> Encoding<span class="token punctuation">.</span>UTF8<span class="token punctuation">.</span><span class="token function">GetBytes</span><span class="token punctuation">(</span>message<span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token keyword">await</span> pipe<span class="token punctuation">.</span><span class="token function">WriteAsync</span><span class="token punctuation">(</span>request<span class="token punctuation">,</span> <span class="token number">0</span><span class="token punctuation">,</span> request<span class="token punctuation">.</span>Length<span class="token punctuation">)</span><span class="token punctuation">;</span>

    <span class="token comment">// Асинхронное чтение ответа сервера</span>
    <span class="token class-name">Byte<span class="token punctuation">[</span><span class="token punctuation">]</span></span> response <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token constructor-invocation class-name">Byte</span><span class="token punctuation">[</span><span class="token number">1000</span><span class="token punctuation">]</span><span class="token punctuation">;</span>
    <span class="token class-name">Int32</span> bytesRead <span class="token operator">=</span> <span class="token keyword">await</span> pipe<span class="token punctuation">.</span><span class="token function">ReadAsync</span><span class="token punctuation">(</span>response<span class="token punctuation">,</span> <span class="token number">0</span><span class="token punctuation">,</span> response<span class="token punctuation">.</span>Length<span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token keyword">return</span> Encoding<span class="token punctuation">.</span>UTF8<span class="token punctuation">.</span><span class="token function">GetString</span><span class="token punctuation">(</span>response<span class="token punctuation">,</span> <span class="token number">0</span><span class="token punctuation">,</span> bytesRead<span class="token punctuation">)</span><span class="token punctuation">;</span>
  <span class="token punctuation">}</span> <span class="token comment">// Закрытие канала</span>
<span class="token punctuation">}</span>
</code></pre><div class="line-numbers" aria-hidden="true"><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div></div></div><p>Асинхронная функция помечается ключевым словом <code>async</code>. Такой метод преобразуется компилятором в конечных автомат. Это позволяет потоку выполнить часть кода в конечном автомате, а затем вернуть управления без выполнения всего метода до завершения. Когда выполнение метода доходит до строки с ключевым словом <code>await</code>, вызывается метод <code>Task.ContinueWith()</code> с передачей метода, возобновляющее выполнение конечного автомата, после чего поток возвращает управление из асинхронного метода.</p><p>В будущем драйвер сетевого устройства завершит запись данных в канал, поток из пула оповестит об этом <code>Task</code>, что приведёт к активизации метода обратного вызова <code>ContinueWith()</code>, заставляющего поток возобновить выполнение конечного автомат. Если конкретнее, поток заново входит в асинхронный метод, но в точке оператора <code>await</code>. Теперь выполнится сгенерированный компилятором код, запрашивающий состояние объекта <code>Task</code>. Если операция завершается успешно, оператор <code>await</code> возвращает результат. Аналогичная ситуация произойдёт со следующим оператором <code>await</code>. После чего выполнится оставшаяся часть кода, а сборщик мусора при необходимости освободит память.</p><p>Так как асинхронные функции возвращают управление до того, как их конечный автомат отработает до завершения, выполнение метода, вызвавшего асинхронную функцию, продолжится сразу после того, как функция выполнит свой первый оператор <code>await</code>. Вызывающая сторона узнает, что выполнение конечного автомата завершилось, так как при пометке метода ключевым словом <code>async</code> компилятор генерирует код, создающий <code>Task</code> в начале выполнения автомата, который завершится при завершении конечного автомата.</p><p>Для асинхронных функций действует ряд ограничений:</p><ul><li>Метод <code>Main()</code> не может быть асинхронным. Кроме того, асинхронными не могут быть конструкторы, методы доступа свойств и методы доступа событий.</li><li>Асинхронная функция не может иметь параметры <code>out</code> и <code>ref</code>.</li><li>Оператор <code>await</code> не может использоваться в блоках <code>catch</code>, <code>finally</code> или <code>unsafe</code>.</li><li>Не допускается установление блокировки, поддерживающей владение потоком или рекурсию, до операции <code>await</code> и её снятие после этого оператора. Это объясняется тем, что один поток может выполнять код до <code>await</code>, а другой - после. При использовании <code>await</code> с конструкцией C# <code>lock</code> компилятор выдаёт сообщение об ошибке. Если вместо этого явно вызвать методы <code>Monitor.Enter()</code> и <code>Monitor.Exit()</code>, то код скомпилируется, то во время выполнения возникнет исключение.</li><li>В выражениях запросов оператор <code>await</code> может использоваться только в первом выражении коллекции условия <code>from</code> или в выражении коллекции условия <code>join</code>.</li></ul><p>Обо всех этих ограничениях сообщает компилятор.</p><h2 id="преобразование-асинхроннои-функции-в-конечныи-автомат" tabindex="-1"><a class="header-anchor" href="#преобразование-асинхроннои-функции-в-конечныи-автомат"><span>Преобразование асинхронной функции в конечный автомат</span></a></h2><p>Исходный код:</p><div class="language-csharp line-numbers-mode" data-ext="cs" data-title="cs"><pre class="language-csharp"><code><span class="token keyword">internal</span> <span class="token keyword">sealed</span> <span class="token keyword">class</span> <span class="token class-name">Type1</span> <span class="token punctuation">{</span> <span class="token punctuation">}</span>
<span class="token keyword">internal</span> <span class="token keyword">sealed</span> <span class="token keyword">class</span> <span class="token class-name">Type2</span> <span class="token punctuation">{</span> <span class="token punctuation">}</span>
<span class="token keyword">private</span> <span class="token keyword">static</span> <span class="token keyword">async</span> <span class="token return-type class-name">Task<span class="token punctuation">&lt;</span>Type1<span class="token punctuation">&gt;</span></span> <span class="token function">Method1Async</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{</span> <span class="token comment">/* Асинхронная операция, возвращающая объект Type1 */</span> <span class="token punctuation">}</span>
<span class="token keyword">private</span> <span class="token keyword">static</span> <span class="token keyword">async</span> <span class="token return-type class-name">Task<span class="token punctuation">&lt;</span>Type2<span class="token punctuation">&gt;</span></span> <span class="token function">Method2Async</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{</span> <span class="token comment">/* Асинхронная операция, возвращающая объект Type2 */</span> <span class="token punctuation">}</span>

<span class="token keyword">private</span> <span class="token keyword">static</span> <span class="token keyword">async</span> <span class="token return-type class-name">Task<span class="token punctuation">&lt;</span>String<span class="token punctuation">&gt;</span></span> <span class="token function">MyMethodAsync</span><span class="token punctuation">(</span><span class="token class-name">Int32</span> argument<span class="token punctuation">)</span>
<span class="token punctuation">{</span>
  <span class="token class-name">Int32</span> local <span class="token operator">=</span> argument<span class="token punctuation">;</span>
  <span class="token keyword">try</span>
  <span class="token punctuation">{</span>
    <span class="token class-name">Type1</span> result1 <span class="token operator">=</span> <span class="token keyword">await</span> <span class="token function">Method1Async</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token keyword">for</span> <span class="token punctuation">(</span><span class="token class-name">Int32</span> x <span class="token operator">=</span> <span class="token number">0</span><span class="token punctuation">;</span> x <span class="token operator">&lt;</span> <span class="token number">3</span><span class="token punctuation">;</span> x<span class="token operator">++</span><span class="token punctuation">)</span>
    <span class="token punctuation">{</span>
      <span class="token class-name">Type2</span> result2 <span class="token operator">=</span> <span class="token keyword">await</span> <span class="token function">Method2Async</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span>
  <span class="token punctuation">}</span>
  <span class="token keyword">catch</span> <span class="token punctuation">(</span><span class="token class-name">Exception</span><span class="token punctuation">)</span>
  <span class="token punctuation">{</span>
    Console<span class="token punctuation">.</span><span class="token function">WriteLine</span><span class="token punctuation">(</span><span class="token string">&quot;Catch&quot;</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
  <span class="token punctuation">}</span>
  <span class="token keyword">finally</span>
  <span class="token punctuation">{</span>
    Console<span class="token punctuation">.</span><span class="token function">WriteLine</span><span class="token punctuation">(</span><span class="token string">&quot;Finally&quot;</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
  <span class="token punctuation">}</span>
  <span class="token keyword">return</span> <span class="token string">&quot;Done&quot;</span><span class="token punctuation">;</span>
<span class="token punctuation">}</span>
</code></pre><div class="line-numbers" aria-hidden="true"><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div></div></div><p>Код конечного автомата:</p><div class="language-csharp line-numbers-mode" data-ext="cs" data-title="cs"><pre class="language-csharp"><code><span class="token comment">// Атрибут AsyncStateMachine обозначает асинхронный метод (полезно для инструментов, использующих отражение);</span>
<span class="token comment">// тип указывает, какая структура реализует конечный автомат.</span>
<span class="token punctuation">[</span><span class="token attribute"><span class="token class-name">DebuggerStepThrough</span><span class="token punctuation">,</span> <span class="token class-name">AsyncStateMachine</span><span class="token attribute-arguments"><span class="token punctuation">(</span><span class="token keyword">typeof</span><span class="token punctuation">(</span><span class="token type-expression class-name">StateMachine</span><span class="token punctuation">)</span><span class="token punctuation">)</span></span></span><span class="token punctuation">]</span>
<span class="token keyword">private</span> <span class="token keyword">static</span> <span class="token return-type class-name">Task<span class="token punctuation">&lt;</span>String<span class="token punctuation">&gt;</span></span> <span class="token function">MyMethodAsync</span><span class="token punctuation">(</span><span class="token class-name">Int32</span> argument<span class="token punctuation">)</span>
<span class="token punctuation">{</span>
  <span class="token comment">// Создание экземпляра конечного автомата и его инициализация</span>
  <span class="token class-name">StateMachine</span> stateMachine <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token constructor-invocation class-name">StateMachine</span><span class="token punctuation">(</span><span class="token punctuation">)</span>
  <span class="token punctuation">{</span>
    <span class="token comment">// Создание построителя, возвращающего Task&lt;String&gt;.</span>
    <span class="token comment">// Конечный автомат обращается к построителю для назначения завершения задания или выдачи исключения.</span>
    m_builder <span class="token operator">=</span> AsyncTaskMethodBuilder<span class="token operator">&lt;</span>String<span class="token operator">&gt;</span><span class="token punctuation">.</span><span class="token function">Create</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">,</span>
    m_state <span class="token operator">=</span> ­<span class="token number">1</span><span class="token punctuation">,</span> <span class="token comment">// инициализация местонахождения</span>
    m_argument <span class="token operator">=</span> argument <span class="token comment">// Копирование аргументов в поля конечного автомата</span>
  <span class="token punctuation">}</span><span class="token punctuation">;</span>

  <span class="token comment">// Начало выполнения конечного автомата.</span>
  stateMachine<span class="token punctuation">.</span>m_builder<span class="token punctuation">.</span><span class="token function">Start</span><span class="token punctuation">(</span><span class="token keyword">ref</span> stateMachine<span class="token punctuation">)</span><span class="token punctuation">;</span>
  <span class="token keyword">return</span> stateMachine<span class="token punctuation">.</span>m_builder<span class="token punctuation">.</span>Task<span class="token punctuation">;</span> <span class="token comment">// Возвращение задания конечного автомата</span>
<span class="token punctuation">}</span> 

<span class="token comment">// Структура конечного автомата</span>
<span class="token punctuation">[</span><span class="token attribute"><span class="token class-name">CompilerGenerated</span><span class="token punctuation">,</span> <span class="token class-name">StructLayout</span><span class="token attribute-arguments"><span class="token punctuation">(</span>LayoutKind<span class="token punctuation">.</span>Auto<span class="token punctuation">)</span></span></span><span class="token punctuation">]</span>
<span class="token keyword">private</span> <span class="token keyword">struct</span> <span class="token class-name">StateMachine</span> <span class="token punctuation">:</span> <span class="token type-list"><span class="token class-name">IAsyncStateMachine</span></span>
<span class="token punctuation">{</span>
  <span class="token comment">// Поля для построителя конечного автомата (Task) и его местонахождения</span>
  <span class="token keyword">public</span> <span class="token class-name">AsyncTaskMethodBuilder<span class="token punctuation">&lt;</span>String<span class="token punctuation">&gt;</span></span> m_builder<span class="token punctuation">;</span>
  <span class="token keyword">public</span> <span class="token class-name">Int32</span> m_state<span class="token punctuation">;</span>

  <span class="token comment">// Аргумент и локальные переменные становятся полями:</span>
  <span class="token keyword">public</span> <span class="token class-name">Int32</span> m_argument<span class="token punctuation">,</span> m_local<span class="token punctuation">,</span> m_x<span class="token punctuation">;</span>
  <span class="token keyword">public</span> <span class="token class-name">Type1</span> m_resultType1<span class="token punctuation">;</span>
  <span class="token keyword">public</span> <span class="token class-name">Type2</span> m_resultType2<span class="token punctuation">;</span>

  <span class="token comment">// Одно поле на каждый тип Awaiter.</span>
  <span class="token comment">// В любой момент времени важно только одно из этих полей.</span>
  <span class="token comment">// В нем хранится ссылка на последний выполненный экземпляр await, который завершается асинхронно:</span>
  <span class="token keyword">private</span> <span class="token class-name">TaskAwaiter<span class="token punctuation">&lt;</span>Type1<span class="token punctuation">&gt;</span></span> m_awaiterType1<span class="token punctuation">;</span>
  <span class="token keyword">private</span> <span class="token class-name">TaskAwaiter<span class="token punctuation">&lt;</span>Type2<span class="token punctuation">&gt;</span></span> m_awaiterType2<span class="token punctuation">;</span>

  <span class="token comment">// Сам конечный автомат</span>
  <span class="token return-type class-name"><span class="token keyword">void</span></span> IAsyncStateMachine<span class="token punctuation">.</span><span class="token function">MoveNext</span><span class="token punctuation">(</span><span class="token punctuation">)</span>
  <span class="token punctuation">{</span>
    <span class="token class-name">String</span> result <span class="token operator">=</span> <span class="token keyword">null</span><span class="token punctuation">;</span> <span class="token comment">// Результат Task</span>

    <span class="token comment">// Вставленный компилятором блок try гарантирует завершение задания конечного автомата</span>
    <span class="token keyword">try</span>
    <span class="token punctuation">{</span>
      <span class="token class-name">Boolean</span> executeFinally <span class="token operator">=</span> <span class="token boolean">true</span><span class="token punctuation">;</span> <span class="token comment">// Логический выход из блока &#39;try&#39;</span>

      <span class="token keyword">if</span> <span class="token punctuation">(</span>m_state <span class="token operator">==</span> ­<span class="token number">1</span><span class="token punctuation">)</span>
      <span class="token punctuation">{</span>                       <span class="token comment">// Если метод конечного автомата выполняется впервые</span>
        m_local <span class="token operator">=</span> m_argument<span class="token punctuation">;</span> <span class="token comment">// Выполнить начало исходного метода</span>
      <span class="token punctuation">}</span>

      <span class="token comment">// Блок try из исходного кода</span>
      <span class="token keyword">try</span>
      <span class="token punctuation">{</span>
        <span class="token class-name">TaskAwaiter<span class="token punctuation">&lt;</span>Type1<span class="token punctuation">&gt;</span></span> awaiterType1<span class="token punctuation">;</span>
        <span class="token class-name">TaskAwaiter<span class="token punctuation">&lt;</span>Type2<span class="token punctuation">&gt;</span></span> awaiterType2<span class="token punctuation">;</span>

        <span class="token keyword">switch</span> <span class="token punctuation">(</span>m_state<span class="token punctuation">)</span>
        <span class="token punctuation">{</span>
          <span class="token keyword">case</span> ­<span class="token number">1</span><span class="token punctuation">:</span> <span class="token comment">// Начало исполнения кода в &#39;try&#39;</span>
          <span class="token comment">// вызвать Method1Async и получить его объект ожидания</span>
          awaiterType1 <span class="token operator">=</span> <span class="token function">Method1Async</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">GetAwaiter</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>

          <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token operator">!</span>awaiterType1<span class="token punctuation">.</span>IsCompleted<span class="token punctuation">)</span>
          <span class="token punctuation">{</span>
            m_state <span class="token operator">=</span> <span class="token number">0</span><span class="token punctuation">;</span> <span class="token comment">// &#39;Method1Async&#39; завершается асинхронно</span>
            m_awaiterType1 <span class="token operator">=</span> awaiterType1<span class="token punctuation">;</span> <span class="token comment">// Сохранить объект ожидания до возвращения</span>
            <span class="token comment">// Приказать объекту ожидания вызвать MoveNext после завершения операции</span>
            m_builder<span class="token punctuation">.</span><span class="token function">AwaitUnsafeOnCompleted</span><span class="token punctuation">(</span><span class="token keyword">ref</span> awaiterType1<span class="token punctuation">,</span> <span class="token keyword">ref</span> <span class="token keyword">this</span><span class="token punctuation">)</span><span class="token punctuation">;</span>

            <span class="token comment">// Предыдущая строка вызывает метод OnCompleted объекта awaiterType1, что приводит к вызову ContinueWith(t =&gt; MoveNext()) для Task.</span>
            <span class="token comment">// При завершении Task ContinueWith вызывает MoveNext</span>
            executeFinally <span class="token operator">=</span> <span class="token boolean">false</span><span class="token punctuation">;</span> <span class="token comment">// Без логического выхода из блока &#39;try&#39;</span>
            <span class="token keyword">return</span><span class="token punctuation">;</span> <span class="token comment">// Поток возвращает управление вызывающей стороне</span>
          <span class="token punctuation">}</span>

          <span class="token comment">// &#39;Method1Async&#39; завершается синхронно.</span>
          <span class="token keyword">break</span><span class="token punctuation">;</span>

          <span class="token keyword">case</span> <span class="token number">0</span><span class="token punctuation">:</span> <span class="token comment">// &#39;Method1Async&#39; завершается асинхронно</span>
            awaiterType1 <span class="token operator">=</span> m_awaiterType1<span class="token punctuation">;</span> <span class="token comment">// Восстановление последнего объекта ожидания</span>
            <span class="token keyword">break</span><span class="token punctuation">;</span> 

          <span class="token keyword">case</span> <span class="token number">1</span><span class="token punctuation">:</span> <span class="token comment">// &#39;Method2Async&#39; завершается асинхронно</span>
            awaiterType2 <span class="token operator">=</span> m_awaiterType2<span class="token punctuation">;</span> <span class="token comment">// Восстановление последнего объекта ожидания</span>
            <span class="token keyword">goto</span> ForLoopEpilog<span class="token punctuation">;</span>
        <span class="token punctuation">}</span>

        <span class="token comment">// После первого await сохраняем результат и запускаем цикл &#39;for&#39;</span>
        m_resultType1 <span class="token operator">=</span> awaiterType1<span class="token punctuation">.</span><span class="token function">GetResult</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span> <span class="token comment">// Получение результата</span>

        ForLoopPrologue<span class="token punctuation">:</span>
          m_x <span class="token operator">=</span> <span class="token number">0</span><span class="token punctuation">;</span> <span class="token comment">// Инициализация цикла &#39;for&#39;</span>
          <span class="token keyword">goto</span> ForLoopBody<span class="token punctuation">;</span> <span class="token comment">// Переход к телу цикла &#39;for&#39;</span>

        ForLoopEpilog<span class="token punctuation">:</span>
          m_resultType2 <span class="token operator">=</span> awaiterType2<span class="token punctuation">.</span><span class="token function">GetResult</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
          m_x<span class="token operator">++</span><span class="token punctuation">;</span> <span class="token comment">// Увеличение x после каждой итерации</span>

        <span class="token comment">// Переход к телу цикла &#39;for&#39;</span>
        ForLoopBody<span class="token punctuation">:</span>
          <span class="token keyword">if</span> <span class="token punctuation">(</span>m_x <span class="token operator">&lt;</span> <span class="token number">3</span><span class="token punctuation">)</span>
          <span class="token punctuation">{</span> <span class="token comment">// Условие цикла &#39;for&#39;</span>
            <span class="token comment">// Вызов Method2Async и получение объекта ожидания</span>
            awaiterType2 <span class="token operator">=</span> <span class="token function">Method2Async</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">GetAwaiter</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>

            <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token operator">!</span>awaiterType2<span class="token punctuation">.</span>IsCompleted<span class="token punctuation">)</span>
            <span class="token punctuation">{</span>
              m_state <span class="token operator">=</span> <span class="token number">1</span><span class="token punctuation">;</span> <span class="token comment">// &#39;Method2Async&#39; завершается асинхронно</span>
              m_awaiterType2 <span class="token operator">=</span> awaiterType2<span class="token punctuation">;</span> <span class="token comment">// Сохранение объекта ожидания до возвращения</span>

              <span class="token comment">// Приказываем вызвать MoveNext при завершении операции</span>
              m_builder<span class="token punctuation">.</span><span class="token function">AwaitUnsafeOnCompleted</span><span class="token punctuation">(</span><span class="token keyword">ref</span> awaiterType2<span class="token punctuation">,</span> <span class="token keyword">ref</span> <span class="token keyword">this</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
              executeFinally <span class="token operator">=</span> <span class="token boolean">false</span><span class="token punctuation">;</span> <span class="token comment">// Без логического выхода из блока &#39;try&#39;</span>
              <span class="token keyword">return</span><span class="token punctuation">;</span> <span class="token comment">// Поток возвращает управление вызывающей стороне</span>
            <span class="token punctuation">}</span>

            <span class="token comment">// &#39;Method2Async&#39; завершается синхронно</span>
            <span class="token keyword">goto</span> ForLoopEpilog<span class="token punctuation">;</span> <span class="token comment">// Синхронное завершение, возврат</span>
          <span class="token punctuation">}</span>
      <span class="token punctuation">}</span>
      <span class="token keyword">catch</span> <span class="token punctuation">(</span><span class="token class-name">Exception</span><span class="token punctuation">)</span>
      <span class="token punctuation">{</span>
        Console<span class="token punctuation">.</span><span class="token function">WriteLine</span><span class="token punctuation">(</span><span class="token string">&quot;Catch&quot;</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
      <span class="token punctuation">}</span>
      <span class="token keyword">finally</span>
      <span class="token punctuation">{</span>
        <span class="token comment">// Каждый раз, когда блок физически выходит из &#39;try&#39;, выполняется &#39;finally&#39;.</span>
        <span class="token comment">// Этот код должен выполняться только при логическом выходе из &#39;try&#39;.</span>
        <span class="token keyword">if</span> <span class="token punctuation">(</span>executeFinally<span class="token punctuation">)</span>
        <span class="token punctuation">{</span>
          Console<span class="token punctuation">.</span><span class="token function">WriteLine</span><span class="token punctuation">(</span><span class="token string">&quot;Finally&quot;</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token punctuation">}</span>
      <span class="token punctuation">}</span>
      result <span class="token operator">=</span> <span class="token string">&quot;Done&quot;</span><span class="token punctuation">;</span> <span class="token comment">// То, что в конечном итоге должна вернуть асинхронная функция.</span>
    <span class="token punctuation">}</span> 
    <span class="token keyword">catch</span> <span class="token punctuation">(</span><span class="token class-name">Exception</span> exception<span class="token punctuation">)</span>
    <span class="token punctuation">{</span>
      <span class="token comment">// Необработанное исключение: задание конечного автомата  завершается с исключением.</span>
      m_builder<span class="token punctuation">.</span><span class="token function">SetException</span><span class="token punctuation">(</span>exception<span class="token punctuation">)</span><span class="token punctuation">;</span>
      <span class="token keyword">return</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span>

    <span class="token comment">// Исключения нет: задание конечного автомата завершается с результатом</span>
    m_builder<span class="token punctuation">.</span><span class="token function">SetResult</span><span class="token punctuation">(</span>result<span class="token punctuation">)</span><span class="token punctuation">;</span>
  <span class="token punctuation">}</span>
<span class="token punctuation">}</span>
</code></pre><div class="line-numbers" aria-hidden="true"><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div></div></div><p>Каждый раз, когда в коде используется оператор <code>await</code>, компилятор берёт указанный операнд и пытается вызвать для него метод <code>GetAwaiter()</code>. Он может быть как экземплярным, так и методом расширения. Объект, возвращаемый при вызове этого метода, называется <em>объектом ожидания</em> (awaiter).</p><p>После того, как конечный автомат получает объект ожидания, он запрашивает его свойство <code>IsCompleted</code>. Если операция завершается синхронно, возвращается <code>true</code> и конечный автомат продолжает выполнение. Он вызывает метод <code>GetResult()</code>? который либо выдаёт исключение, либо возвращает результат. Конечный автомат продолжает выполнение для обработки результата.</p><p>Если операция завершается асинхронно, то возвращается <code>false</code>. В этом случае вызывается метод <code>OnCompleted()</code> объекта ожидания, передавая ему делегат метода <code>MoveNext()</code> конечного автомата. И теперь конечный автомат позволяет своему потоку вернуть управление в сходную точку, чтобы тот мог продолжить выполнение другого кода. В будущем объект ожидания узнает о своём завершении и вызывает делегата, что приводит к исполнению <code>MoveNext()</code>. По полям конечного автомата определяется способ перехода к правильной точке кода, что создаёт иллюзию продолжения выполнения метода с того места, с которого он был прерван. На этой стадии код вызывает <code>GetResult()</code> и продолжает выполнение для обработки результата.</p><h2 id="расширяемость-асинхронных-функции" tabindex="-1"><a class="header-anchor" href="#расширяемость-асинхронных-функции"><span>Расширяемость асинхронных функций</span></a></h2><p>Представление всех видов асинхронных операций одним типом <code>Task</code> позволяет реализовывать комбинаторы (<code>Task.WhenAny()</code> и <code>Task.WhenAll()</code>) и другие полезные операции.</p><p>Наряду с гибкостью асинхронные функции предоставляют ещё одну точку расширения: компилятор вызывает <code>GetAwaiter()</code> для операнда, использовавшегося с <code>await</code>. Таким образом, операнд не обязан быть <code>Task</code>, он может относиться к любому типу. содержащему <code>GetAwaiter()</code>.</p><h2 id="асинхронные-функции-и-обработчики-событии" tabindex="-1"><a class="header-anchor" href="#асинхронные-функции-и-обработчики-событии"><span>Асинхронные функции и обработчики событий</span></a></h2><p>Для асинхронных функций возможно определение возвращаемого типа как <code>void</code>. Это особый случай, который поддерживается компилятором для реализации асинхронного обработчика события. В таком случае асинхронна функция превращается в конечный автомат, но не создаёт объект <code>Task</code>, из-за чего нельзя узнать о завершённости задания.</p><p>Метод <code>Main()</code> нельзя пометить ключевым словом <code>async</code> и внутри него нельзя использовать операторы <code>await</code>, так как в этом случае управление вернётся сразу же после выполнения первого оператора <code>await</code>, а поскольку метод <code>Main()</code> не асинхронный, то он не создаёт таску и нельзя будет отследить его завершённость. Для предотвращения подобного поведения компилятор выдаёт ошибку.</p><h2 id="асинхронные-функции-fcl" tabindex="-1"><a class="header-anchor" href="#асинхронные-функции-fcl"><span>Асинхронные функции FCL</span></a></h2><p>Асинхронные функции легко освоить они просты в использовании и поддерживаются многими типами FCL. Кроме того, они сразу видны в коде, так как чаще всего имя метода снабжается суффиксом <code>Async</code>.</p><p>До модели асинхронных функций (TAP, Task-based Asynchronous Pattern) существовали также и другие подходы:</p><ul><li>EAP (Event-based Asynchronous Pattern) — подход основан на событиях, которые срабатывают по завершении операции и обычного метода, вызывающего эту операцию.</li><li>APM (Asynchronous Programming Model) — основан на 2 методах: <code>BeginSmth()</code> возвращает интерфейс <code>IAsyncResult</code>, метод <code>EndSmth()</code> принимает <code>IAsyncResult</code> (если к моменту вызова <code>EndSmth()</code> операция не завершена, поток блокируется).</li></ul><p>В некоторых классах FCL можно встретить APM подход, так как не всё успели переписать под TAP. Если необходимо воспользоваться одним из таких классов, то его можно привести к новой модели с помощью метода <code>Task.Factory.FromAsync()</code>. Если же используется EAP, то в FCL нет вспомогательных методов-адаптеров, поэтому адаптировать придётся вручную.</p><h2 id="асинхронные-функции-и-исключения" tabindex="-1"><a class="header-anchor" href="#асинхронные-функции-и-исключения"><span>Асинхронные функции и исключения</span></a></h2><p>При использовании <code>await</code> с <code>Task</code> вместо <code>AggregateException</code> выдаётся первое внутреннее исключение, чтобы поведение кода соответствовало ожиданиям разработчиков.</p><h2 id="другие-возможности-асинхронных-функции" tabindex="-1"><a class="header-anchor" href="#другие-возможности-асинхронных-функции"><span>Другие возможности асинхронных функций</span></a></h2><p>В разделе рассказывается подробнее про отладку асинхронных функций.</p><p>С помощью <code>Task.Run()</code> можно запустить асинхронную функцию в потоке. отличном от вызывающего.</p><p>Кроме того, в разделе описывается использование асинхронных лямбда-выражений и способы обхода предупреждений компилятора в случае, если внутри асинхронного метода не используется оператор <code>await</code>.</p><h2 id="потоковые-модели-приложении" tabindex="-1"><a class="header-anchor" href="#потоковые-модели-приложении"><span>Потоковые модели приложений</span></a></h2><p>Консольные приложение и Windows-службы не навязывают никакой потоковой модели. Приложение с графическим интерфейсом предлагают такую модель, в которой обновлять окно может только создавший его поток, GUI-потоки обычно порождают асинхронные операции.</p><p>Приложения ASP.NET позволяют любому потоку делать всё, что угодно. Порождённая одним потоком пула асинхронная операция может заканчиваться другим потоком, который обрабатывает её результат. При этом при переходе между потоками должен сохраняться контекст.</p><p>При разработке библиотек классов стоит принимать во внимание класс <code>SynchronizationContext</code>, что позволит создать высокопроизводительный код. Кроме того, при разработке стоит сделать всё возможное, чтобы пользователи библиотеки избежали взаимной блокировки. Для решения этих проблем классы <code>Task</code> и <code>Task&lt;TResult&gt;</code> предоставляют метод <code>ConfigureAwait()</code>. Если передать в этот метод <code>false</code>, то оператор <code>await</code> не запрашивает контекст синхронизации вызывающего потока, а когда поток пула завершает выполнение задания, происходит простое завершение.</p><h2 id="асинхронная-реализация-сервера" tabindex="-1"><a class="header-anchor" href="#асинхронная-реализация-сервера"><span>Асинхронная реализация сервера</span></a></h2><p>В разделе описывается построение асинхронных серверов с хорошей масштабируемостью для:</p><ul><li>Web Forms ASP.NET.</li><li>Асинхронных MVC-контроллеров ASP.NET.</li><li>Асинхронного обработчика ASP.NET.</li><li>Асинхронной службы WCF.</li></ul><h2 id="отмена-операции-ввода-вывода" tabindex="-1"><a class="header-anchor" href="#отмена-операции-ввода-вывода"><span>Отмена операций ввода-вывода</span></a></h2><p>В общем случае не существует возможности отмены затянувшейся операции ввода-вывода, потому что отменить посланный на сервер запрос уже не удастся. Кроме того, может возникнуть ситуация гонки. Если флаг отмены придёт в тот момент, когда сервер пришлёт ответ, то как быть? В разделе Рихтер предлагает реализовать метод расширения, который бы завершал такой <code>Task</code> при отмене.</p><h3 id="некоторые-операции-ввода-вывода-должны-выполняться-синхронно" tabindex="-1"><a class="header-anchor" href="#некоторые-операции-ввода-вывода-должны-выполняться-синхронно"><span>Некоторые операции ввода-вывода должны выполняться синхронно</span></a></h3><p>В разделе описываются ситуации, для которых недоступны асинхронные операции и как их можно избежать.</p><h3 id="проблемы-filestream" tabindex="-1"><a class="header-anchor" href="#проблемы-filestream"><span>Проблемы FileStream</span></a></h3><p>При работе с <code>FileStream</code> стоит заранее выбрать синхронным или асинхронным будет ввод-вывод файлов и установить соответствующий флаг. При этом стоит использовать соответствующий (синхронный или асинхронный) метод.</p><h2 id="приоритеты-запросов-ввода-вывода" tabindex="-1"><a class="header-anchor" href="#приоритеты-запросов-ввода-вывода"><span>Приоритеты запросов ввода-вывода</span></a></h2><p>Windows позволяет указать приоритет потока при выполнении запросов ввода-вывода. В FCL данная функциональность не реализована, на данный момент преимуществами данного функционала можно воспользоваться при помощи механизма P/Invoking.</p></div><!--[--><!--]--></div><footer class="vp-page-meta"><div class="vp-meta-item edit-link"><a class="external-link label" href="https://github.com/arytry/clr-via-csharp/edit/main/docs/ru/chapters/ch28_IOBoundAsyncOperations.md" rel="noopener noreferrer" target="_blank" aria-label="Edit this page"><!--[--><!--[--><svg class="icon" viewBox="0 0 1024 1024"><g fill="currentColor"><path d="M430.818 653.65a60.46 60.46 0 0 1-50.96-93.281l71.69-114.012 7.773-10.365L816.038 80.138A60.46 60.46 0 0 1 859.225 62a60.46 60.46 0 0 1 43.186 18.138l43.186 43.186a60.46 60.46 0 0 1 0 86.373L588.879 565.55l-8.637 8.637-117.466 68.234a60.46 60.46 0 0 1-31.958 11.229z"></path><path d="M728.802 962H252.891A190.883 190.883 0 0 1 62.008 771.98V296.934a190.883 190.883 0 0 1 190.883-192.61h267.754a60.46 60.46 0 0 1 0 120.92H252.891a69.962 69.962 0 0 0-69.098 69.099V771.98a69.962 69.962 0 0 0 69.098 69.098h475.911A69.962 69.962 0 0 0 797.9 771.98V503.363a60.46 60.46 0 1 1 120.922 0V771.98A190.883 190.883 0 0 1 728.802 962z"></path></g></svg><!--]--> Edit this page <span><svg class="external-link-icon" xmlns="http://www.w3.org/2000/svg" aria-hidden="true" focusable="false" x="0px" y="0px" viewBox="0 0 100 100" width="15" height="15"><path fill="currentColor" d="M18.8,85.1h56l0,0c2.2,0,4-1.8,4-4v-32h-8v28h-48v-48h28v-8h-32l0,0c-2.2,0-4,1.8-4,4v56C14.8,83.3,16.6,85.1,18.8,85.1z"></path><polygon fill="currentColor" points="45.7,48.7 51.3,54.3 77.2,28.5 77.2,37.2 85.2,37.2 85.2,14.9 62.8,14.9 62.8,22.9 71.5,22.9"></polygon></svg><span class="external-link-icon-sr-only">open in new window</span></span><!--[--><!--]--><!--]--></a></div><div class="vp-meta-item git-info"><div class="vp-meta-item last-updated"><span class="meta-item-label">Last Updated: </span><!----></div><!----></div></footer><nav class="vp-page-nav" aria-label="page navigation"><a class="route-link prev" href="/clr-via-csharp/ru/chapters/ch27_ComputeBoundAsync.html" aria-label="Асинхронные вычислительные операции"><!--[--><div class="hint"><span class="arrow left"></span> Prev</div><div class="link"><span>Асинхронные вычислительные операции</span></div><!--]--></a><a class="route-link next" href="/clr-via-csharp/ru/chapters/ch29_PrimitiveThreadSyncConstructs.html" aria-label="Примитивные конструкции синхронизации потоков"><!--[--><div class="hint">Next <span class="arrow right"></span></div><div class="link"><span>Примитивные конструкции синхронизации потоков</span></div><!--]--></a></nav><!--[--><!--]--></main><!--]--></div><!--[--><!----><!--]--><!--]--></div>
    <script type="module" src="/clr-via-csharp/assets/app-IxoMmWNN.js" defer></script>
  </body>
</html>
